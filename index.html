import React, { useEffect, useMemo, useState } from "react";
import { motion } from "framer-motion";
import { CheckCircle2, AlertTriangle, Dumbbell, Bike, Activity, RefreshCw, Flame, Clock3, Brain, Zap, TrendingUp, X } from "lucide-react";

// Plain React (no TS). Three-state sliders: 0 = Bad, 1 = Fine, 2 = Good.
// Accessories are AUTO-ASSIGNED from bodybuilding pools based on weekly deficits.
// Strength builder: choose pattern (Hinge/Squat/Oly) + top-3 movement sub-select,
// and log multiple sets with per-set Reps & Weight; Add Set button provided.
// Accessories now have WEIGHT inputs, with set/rep defaults aligned to hypertrophy guidelines.
// NEW: The Session Builder now ADAPTS to day type (Strength / Endurance / GPP Good / GPP Bad / Recovery)
// with tailored UI, auto-WOD suggestions, and day-aware accessory biasing.

// --- Utilities
function isoToday() { const d = new Date(); d.setHours(0,0,0,0); return d.toISOString(); }
function uid() { return Math.random().toString(36).slice(2, 9); }
function getWeekKey(date = new Date()) {
  const d = new Date(date);
  const onejan = new Date(d.getFullYear(), 0, 1);
  const millisInDay = 86400000;
  const week = Math.ceil((((d.getTime() - onejan.getTime()) / millisInDay) + onejan.getDay() + 1) / 7);
  return `${d.getFullYear()}-W${String(week).padStart(2, "0")}`;
}
function sum(arr, f) { return arr.reduce((acc, x) => acc + f(x), 0); }
function loadFromLS(key, fallback) { try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : fallback; } catch { return fallback; } }
function saveToLS(key, value) { localStorage.setItem(key, JSON.stringify(value)); }

// --- Badge helper
function badge(color, text) {
  return (
    <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ${color}`}>
      {text}
    </span>
  );
}

// --- Accessory pools (traditional BB variations)
const POOLS = {
  Quads: ["Front-Foot Elevated Split Squat", "Front Squat (light)", "Leg Press", "Hack Squat / Belt Squat", "Step-Up (heavy)", "Goblet Squat (tempo)", "Sissy Squat (controlled)"],
  Posterior: ["Romanian Deadlift", "Hip Thrust / Glute Bridge", "Nordic Curl / Assisted", "Seated Leg Curl", "Back Extension (45°)", "Good Morning (light)", "Cable Pull-Through"],
  Chest: ["DB Bench Press", "Incline DB Press", "Machine Chest Press", "Cable Fly (mid)", "Push-Up (weighted)", "Deficit Push-Up"],
  Back: ["Chest-Supported Row", "One-Arm DB Row", "Lat Pulldown", "Seated Cable Row", "Meadows Row", "T-Bar Row"],
  Delts: ["DB Lateral Raise", "Cable Lateral Raise", "Rear Delt Fly (machine)", "Face Pull", "Y-Raise (incline)", "Leaning Lateral Raise"],
  Arms: ["EZ-Bar Curl", "Incline DB Curl", "Hammer Curl", "Rope Pressdown", "Overhead Cable Extension", "Close-Grip Push-Up"],
  Calves: ["Standing Calf Raise", "Seated Calf Raise", "Donkey Calf Raise", "Single-Leg Calf Raise"],
  Tib: ["Tibialis Raise", "Seated Dorsiflexion (band)", "Tib Bar Raise"],
};

function nextPoolIndex(target, len) {
  const key = `poolIdx:${target}`;
  const curr = Number(localStorage.getItem(key) || 0);
  const next = (curr + 1) % len;
  localStorage.setItem(key, String(next));
  return curr % len; // return current, then advance
}

// --- Recommendation (3-state inputs)
// sleep, nutrition, soreness, mood are all 0..2 where 2 is best (for soreness: 2 = low soreness)
function recommendDay(sleepQ, nutritionQ, sorenessQ, moodQ) {
  const normalized = (sleepQ + nutritionQ + sorenessQ + moodQ) / 8; // 0..1
  if (normalized >= 0.82) return "Strength"; // great day
  if (normalized >= 0.65) return "GPP Good";
  if (normalized >= 0.48) return "Endurance";
  return "GPP Bad"; // worst days route here
}

// --- Totals calculator
function calcTotals(sessions) {
  const totals = { quadsSets: 0, posteriorSets: 0, chestSets: 0, backSets: 0, deltSets: 0, armSets: 0, calvesSets: 0, tibSets: 0,
    zone2Min: 0, vigorousMin: 0, strengthSessions: 0, runAdjacentToStrength: false };
  sessions.forEach(s => {
    if (s.mainLift && s.mainLift.pattern && s.mainLift.sets) {
      const add = s.mainLift.sets;
      if (s.mainLift.pattern === "Knee" || s.mainLift.pattern === "Squat") totals.quadsSets += add; // backward-compatible
      if (s.mainLift.pattern === "Hinge") totals.posteriorSets += add;
      if (s.mainLift.pattern === "Oly") { totals.quadsSets += Math.ceil(add/2); totals.posteriorSets += Math.floor(add/2); }
    }
    totals.zone2Min += s.endurance?.zone2Min ?? 0;
    totals.vigorousMin += s.endurance?.vigorousMin ?? 0;
    totals.quadsSets += sum(s.accessories, a => (a.target === "Quads" ? a.sets : 0));
    totals.posteriorSets += sum(s.accessories, a => (a.target === "Posterior" ? a.sets : 0));
    totals.chestSets += sum(s.accessories, a => (a.target === "Chest" ? a.sets : 0));
    totals.backSets += sum(s.accessories, a => (a.target === "Back" ? a.sets : 0));
    totals.deltSets += sum(s.accessories, a => (a.target === "Delts" ? a.sets : 0));
    totals.armSets += sum(s.accessories, a => (a.target === "Arms" ? a.sets : 0));
    totals.calvesSets += sum(s.accessories, a => (a.target === "Calves" ? a.sets : 0));
    totals.tibSets += sum(s.accessories, a => (a.target === "Tib" ? a.sets : 0));
    if (s.dayKind === "Strength") totals.strengthSessions += 1;
  });
  const anyRun = sessions.some(s => (s.endurance?.modality === "Run") && (((s.endurance?.vigorousMin ?? 0) + (s.endurance?.zone2Min ?? 0)) > 0));
  totals.runAdjacentToStrength = anyRun && totals.strengthSessions > 0;
  return totals;
}

// --- Auto accessory planner (hypertrophy-aligned defaults)
const TARGETS = { Quads: 10, Posterior: 10, Chest: 10, Back: 12, Delts: 10, Arms: 8, Calves: 4, Tib: 4 };

function defaultsFor(target) {
  // Evidence-guided defaults: Big muscles 3×8–12, Arms 3×10–15, Calves/Tib 3×12–20.
  if (target === "Calves" || target === "Tib") return { sets: 3, reps: 15 };
  if (target === "Arms") return { sets: 3, reps: 12 };
  return { sets: 3, reps: 10 }; // Quads/Posterior/Chest/Back/Delts
}

function chooseLaggingTarget(totals) {
  const pairs = [
    ["Quads", totals.quadsSets, TARGETS.Quads],
    ["Posterior", totals.posteriorSets, TARGETS.Posterior],
    ["Chest", totals.chestSets, TARGETS.Chest],
    ["Back", totals.backSets, TARGETS.Back],
    ["Delts", totals.deltSets, TARGETS.Delts],
    ["Arms", totals.armSets, TARGETS.Arms],
    ["Calves", totals.calvesSets, TARGETS.Calves],
    ["Tib", totals.tibSets, TARGETS.Tib],
  ];
  // compute coverage ratio; lower = more behind
  let best = null;
  let bestRatio = Infinity;
  for (const [name, got, need] of pairs) {
    const ratio = need > 0 ? (got / need) : 1;
    if (ratio < bestRatio) { bestRatio = ratio; best = name; }
  }
  return best || "Delts"; // default harmless
}

// Day-aware bias on top of deficits
function chooseLaggingTargetDayAware(totals, dayKind) {
  const weights = {
    Strength: { Quads: 0.8, Posterior: 0.8, Chest: 1.0, Back: 1.0, Delts: 1.0, Arms: 1.1, Calves: 1.0, Tib: 1.0 },
    "GPP Good": { Quads: 0.9, Posterior: 0.9, Chest: 1.0, Back: 1.0, Delts: 1.0, Arms: 1.0, Calves: 1.0, Tib: 1.0 },
    "GPP Bad": { Quads: 1.1, Posterior: 1.1, Chest: 1.0, Back: 1.0, Delts: 1.0, Arms: 1.0, Calves: 0.9, Tib: 0.9 }, // bias to lighter prehab
    Endurance: { Quads: 1.1, Posterior: 1.1, Chest: 0.9, Back: 0.9, Delts: 0.9, Arms: 0.9, Calves: 1.0, Tib: 1.0 },
    Recovery: { Quads: 1.2, Posterior: 1.2, Chest: 1.2, Back: 1.2, Delts: 1.2, Arms: 1.2, Calves: 1.2, Tib: 1.2 },
  }[dayKind] || {};

  const pairs = [
    ["Quads", totals.quadsSets, TARGETS.Quads],
    ["Posterior", totals.posteriorSets, TARGETS.Posterior],
    ["Chest", totals.chestSets, TARGETS.Chest],
    ["Back", totals.backSets, TARGETS.Back],
    ["Delts", totals.deltSets, TARGETS.Delts],
    ["Arms", totals.armSets, TARGETS.Arms],
    ["Calves", totals.calvesSets, TARGETS.Calves],
    ["Tib", totals.tibSets, TARGETS.Tib],
  ];

  let best = null; let bestScore = Infinity;
  for (const [name, got, need] of pairs) {
    const baseRatio = need > 0 ? (got / need) : 1;
    const weight = weights[name] ?? 1.0; // <1 means priority up
    const score = baseRatio * weight;
    if (score < bestScore) { bestScore = score; best = name; }
  }
  return best || chooseLaggingTarget(totals);
}

function makeAccessoryFor(target) {
  const pool = POOLS[target];
  const idx = nextPoolIndex(target, pool.length);
  const name = pool[idx];
  const { sets, reps } = defaultsFor(target);
  return { id: uid(), name, target, sets, reps, load: "" };
}

// --- Strength top-3 movement options per pattern
const TOP3 = {
  Hinge: ["Conventional Deadlift", "Trap Bar Deadlift", "Romanian Deadlift"],
  Squat: ["Back Squat", "Front Squat", "Pause Back Squat"],
  Oly: ["Clean & Jerk", "Clean", "Snatch"],
};

// Quick add chips for WODs
const QUICK_CHIPS = [
  { name: "Air Squat", reps: "15", load: "bodyweight" },
  { name: "Push-Up", reps: "12", load: "bodyweight" },
  { name: "Sit-Up", reps: "20", load: "bodyweight" },
  { name: "KB Swing", reps: "15", load: "moderate" },
  { name: "Row Cal", reps: "12", load: "—" },
  { name: "Bike Cal", reps: "12", load: "—" },
  { name: "DB Snatch (alt)", reps: "12", load: "light" },
  { name: "Box Step-Up", reps: "20", load: "bodyweight" },
  { name: "Dead Hang (sec)", reps: "20", load: "bodyweight" },
];

// --- Component
export default function HybridTrainingAppCard() {
  const weekKey = getWeekKey();
  const [sessions, setSessions] = useState(() => loadFromLS(`sessions:${weekKey}`, []));
  useEffect(() => { saveToLS(`sessions:${weekKey}`, sessions); }, [sessions, weekKey]);

  // Readiness sliders (0 Bad, 1 Fine, 2 Good)
  const [sleep, setSleep] = useState(1);
  const [nutrition, setNutrition] = useState(1);
  const [soreness, setSoreness] = useState(1); // 2 = low soreness (good)
  const [mood, setMood] = useState(1); // 2 = you feel good

  const recommendation = useMemo(() => recommendDay(sleep, nutrition, soreness, mood), [sleep, nutrition, soreness, mood]);

  // Session draft
  const [dayKind, setDayKind] = useState(recommendation);
  const [pattern, setPattern] = useState("None"); // Hinge | Squat | Oly | None
  const [movement, setMovement] = useState("");
  const [rpe, setRpe] = useState(8);
  const [restMin, setRestMin] = useState(3);
  const [workSets, setWorkSets] = useState([{ reps: "", load: "" }]);

  // Endurance + WOD
  const [zone2Min, setZone2Min] = useState(0);
  const [modality, setModality] = useState("Row");
  const [wodEnabled, setWodEnabled] = useState(false);
  const [wodStyle, setWodStyle] = useState("AMRAP"); // AMRAP | For Time | EMOM | Intervals | Chipper
  const [wodName, setWodName] = useState("");
  const [wodCap, setWodCap] = useState(20); // minutes (AMRAP/For Time/Chipper) or time cap
  const [wodRounds, setWodRounds] = useState(3);
  const [wodEmomMin, setWodEmomMin] = useState(12);
  const [wodMovements, setWodMovements] = useState([{ name: "", reps: "", load: "" }]);

  const [accessories, setAccessories] = useState([]);
  const [newAcc, setNewAcc] = useState({ target: "Back", name: "", load: "" });
  const [notes, setNotes] = useState("");

  useEffect(() => { setDayKind(recommendation); }, [recommendation]);

  // update movement list when pattern changes
  useEffect(() => {
    if (pattern === "Hinge" || pattern === "Squat" || pattern === "Oly") {
      setMovement(TOP3[pattern][0]);
    } else {
      setMovement("");
    }
  }, [pattern]);

  // Auto-toggle/adapt builder per dayType
  useEffect(() => {
    if (dayKind === "Strength") { setWodEnabled(false); }
    if (dayKind === "Endurance") { setWodEnabled(false); setZone2Min(zone2Min || 30); }
    if (dayKind === "GPP Good") { if (!wodEnabled) setWodEnabled(true); if (!wodName) loadTemplate('amrap12'); }
    if (dayKind === "GPP Bad") {
      setWodEnabled(true);
      // Easy mover: Air Squat / Push-Up / Dead Hang
      setWodStyle("AMRAP"); setWodName("12′ Easy Mover"); setWodCap(12); setWodRounds(0); setWodEmomMin(0);
      setWodMovements([
        { name: "Air Squat", reps: "15", load: "bodyweight" },
        { name: "Push-Up", reps: "10", load: "bodyweight" },
        { name: "Dead Hang (sec)", reps: "20", load: "bodyweight" },
      ]);
    }
    if (dayKind === "Recovery") { setWodEnabled(false); setZone2Min(30); }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [dayKind]);

  // WOD helpers
  function wodMinutes() {
    if (!wodEnabled) return 0;
    if (wodStyle === "EMOM") return Number(wodEmomMin) || 0;
    // AMRAP / For Time / Chipper / Intervals use cap as primary time budget
    return Number(wodCap) || 0;
  }

  function setWodMove(i, field, value) {
    setWodMovements(prev => prev.map((m, idx) => idx === i ? { ...m, [field]: value } : m));
  }
  function addWodMove() { setWodMovements(prev => [...prev, { name: "", reps: "", load: "" }]); }
  function removeWodMove(i) { setWodMovements(prev => prev.filter((_, idx) => idx !== i)); }
  function addChipMove(m) { setWodMovements(prev => [...prev, { ...m }]); }

  function loadTemplate(key) {
    // Lightweight generic templates to speed up entry
    const templates = {
      amrap12: { style: "AMRAP", name: "AMRAP 12", cap: 12, rounds: 0, emom: 0, moves: [
        { name: "Kettlebell Swing", reps: "15", load: "moderate" },
        { name: "Box Jump", reps: "12", load: "bodyweight" },
        { name: "Burpee", reps: "9", load: "bodyweight" },
      ]},
      fortime4r: { style: "For Time", name: "4 Rounds For Time", cap: 25, rounds: 4, emom: 0, moves: [
        { name: "400m Run", reps: "1", load: "—" },
        { name: "Wall Ball", reps: "20", load: "light" },
        { name: "Sit-Up", reps: "25", load: "bodyweight" },
      ]},
      emom12: { style: "EMOM", name: "EMOM 12 (Alt)", cap: 0, rounds: 0, emom: 12, moves: [
        { name: "Cal Row", reps: "12", load: "—" },
        { name: "Burpees", reps: "10", load: "bodyweight" },
      ]},
      chipper20: { style: "Chipper", name: "20′ Chipper", cap: 20, rounds: 1, emom: 0, moves: [
        { name: "1000m Row", reps: "1", load: "—" },
        { name: "DB Snatch (alt)", reps: "50", load: "light" },
        { name: "Walking Lunge", reps: "100", load: "bodyweight" },
      ]},
    };
    const t = templates[key];
    if (!t) return;
    setWodEnabled(true);
    setWodStyle(t.style);
    setWodName(t.name);
    setWodCap(t.cap);
    setWodRounds(t.rounds);
    setWodEmomMin(t.emom);
    setWodMovements(t.moves);
  }

  const totals = useMemo(() => calcTotals(sessions.concat([{ accessories }].map(x=>({ ...x, mainLift:null, dayKind:"_", endurance:undefined, date:isoToday(), id:"_tmp" })))), [sessions, accessories]);

  // Endurance guideline check
  const enduranceOk = (totals.zone2Min >= 150) || (totals.vigorousMin >= 75) || ((totals.zone2Min * 0.5 + totals.vigorousMin) >= 75);

  const quadsOk = totals.quadsSets >= TARGETS.Quads;
  const posteriorOk = totals.posteriorSets >= TARGETS.Posterior;

  // Work set helpers
  function setSetField(i, field, value) {
    setWorkSets(prev => prev.map((s, idx) => idx === i ? { ...s, [field]: value } : s));
  }
  function addWorkSet() { setWorkSets(prev => [...prev, { reps: "", load: "" }]); }
  function removeWorkSet(i) { setWorkSets(prev => prev.filter((_, idx) => idx !== i)); }
  const hardSetCount = workSets.filter(s => Number(s.reps) > 0 && Number(s.load) > 0).length;

  function saveSession() {
    const wodObj = wodEnabled ? {
      style: wodStyle,
      name: wodName,
      capMin: Number(wodCap) || 0,
      rounds: Number(wodRounds) || 0,
      emomMin: Number(wodEmomMin) || 0,
      movements: wodMovements,
    } : undefined;

    const calculatedVigFromWod = wodMinutes();

    const s = {
      id: uid(), date: isoToday(), dayKind,
      mainLift: dayKind === "Strength" ? {
        pattern: pattern === "Squat" ? "Squat" : (pattern === "Hinge" ? "Hinge" : (pattern === "Oly" ? "Oly" : "None")),
        movement,
        rpe, restMin,
        sets: hardSetCount,
        setsDetail: workSets,
      } : null,
      endurance: (dayKind !== "Strength" || zone2Min > 0 || calculatedVigFromWod > 0) ? { zone2Min, vigorousMin: calculatedVigFromWod, modality } : undefined,
      wod: wodObj,
      accessories, notes,
    };
    setSessions(prev => [...prev, s]);
    setAccessories([]); setNotes(""); setZone2Min(0);
    setWorkSets([{ reps: "", load: "" }]);
    // don't clear WOD so user can repeat template if desired
  }

  function resetWeek() { if (confirm("Reset this week's data?")) setSessions([]); }

  $1  function addManualAccessory() { const t = newAcc.target || "Back"; const base = defaultsFor(t); const a = { id: uid(), name: (newAcc.name||"").trim() || (POOLS[t] ? POOLS[t][0] : "Accessory"), target: t, sets: base.sets, reps: base.reps, load: newAcc.load || "" }; setAccessories(prev => [...prev, a]); setNewAcc({ target: t, name: "", load: "" }); }
  function removeAccessory(id) { setAccessories(prev => prev.filter(a => a.id !== id)); }

  const buildTitle = {
    Strength: "Build Today’s Strength Session",
    Endurance: "Build Today’s Endurance Session",
    "GPP Good": "Build Today’s GPP (Good) Session",
    "GPP Bad": "Build Today’s GPP (Bad) Session",
    Recovery: "Plan Today’s Recovery",
  }[dayKind] || "Build Today’s Session";

  return (
    <div className="min-h-screen w-full bg-neutral-950 text-neutral-100 p-6">
      <div className="max-w-5xl mx-auto grid gap-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl md:text-3xl font-bold tracking-tight flex items-center gap-2">
              <Dumbbell className="h-7 w-7" /> Hybrid Weekly Trainer
            </h1>
            <p className="text-neutral-400">Week <span className="font-semibold">{weekKey}</span> · Evidence-based volume + interference guardrails</p>
          </div>
          <div className="flex items-center gap-2">
            <button onClick={resetWeek} className="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700 text-sm">
              <RefreshCw className="h-4 w-4" /> Reset Week
            </button>
          </div>
        </div>

        {/* Readiness + Recommendation */}
        <motion.div layout className="grid md:grid-cols-2 gap-6">
          <div className="rounded-2xl bg-neutral-900 p-5 shadow-sm border border-neutral-800">
            <h2 className="text-lg font-semibold flex items-center gap-2"><Brain className="h-5 w-5"/> Readiness</h2>
            <p className="text-neutral-400 text-sm mb-4">Step 0 — Rate your inputs: Bad / Fine / Good. For soreness & mood, "Good" = low soreness / feel fine.</p>
            <div className="space-y-4">
              {["Sleep quality", "Nutrition today", "Soreness", "Not feeling it"].map((label, idx) => {
                const pairs = [[sleep, setSleep],[nutrition, setNutrition],[soreness, setSoreness],[mood, setMood]];
                const [val, setVal] = pairs[idx];
                return (
                  <div key={label} className="grid grid-cols-6 items-center gap-3">
                    <label className="col-span-2 text-sm">{label}</label>
                    <input type="range" min={0} max={2} step={1} value={val} onChange={(e)=>setVal(Number(e.target.value))} className="col-span-3" />
                    <div className="col-span-6 -mt-1 flex justify-between text-[10px] text-neutral-400 px-1"><span>Bad</span><span>Fine</span><span>Good</span></div>
                  </div>
                );
              })}
            </div>
          </div>

          <motion.div layout className="rounded-2xl bg-neutral-900 p-5 shadow-sm border border-neutral-800">
            <h2 className="text-lg font-semibold flex items-center gap-2"><Zap className="h-5 w-5"/> Recommendation</h2>
            <p className="text-neutral-400 text-sm mb-3">Your readiness picks the day. Worst days route to <b>GPP Bad</b>. Override if you want.</p>
            <div className="flex items-center gap-2 flex-wrap">
              {badge("bg-emerald-900/40 text-emerald-300", recommendation)}
              {recommendation === "Strength" && badge("bg-emerald-900/20 text-emerald-300", "Long rests · 3–6 reps · RPE 7–9")}
              {recommendation === "Endurance" && badge("bg-sky-900/20 text-sky-300", "30–40′ Zone 2 preferred")}
            </div>
            <div className="mt-4 grid sm:grid-cols-2 gap-3">
              <div className="flex flex-col gap-1">
                <label className="text-xs text-neutral-400">Step 1 — Choose day type</label>
                <select value={dayKind} onChange={(e) => setDayKind(e.target.value)} className="bg-neutral-800 rounded-xl px-3 py-2">
                  {["Strength", "Endurance", "GPP Good", "GPP Bad", "Recovery"].map(k => <option key={k} value={k}>{k}</option>)}
                </select>
              </div>
              {dayKind === "Endurance" && (
                <div className="flex flex-col gap-1">
                  <label className="text-xs text-neutral-400">Endurance Modality</label>
                  <select value={modality} onChange={(e) => setModality(e.target.value)} className="bg-neutral-800 rounded-xl px-3 py-2">
                    {["Row", "Bike", "Run", "Ruck", "Other"].map(m => <option key={m} value={m}>{m}</option>)}
                  </select>
                </div>
              )}
            </div>
          </motion.div>
        </motion.div>

        {/* Session Builder */}
        <motion.div layout className="rounded-2xl bg-neutral-900 p-5 shadow-sm border border-neutral-800">
          <h2 className="text-lg font-semibold flex items-center gap-2"><Activity className="h-5 w-5"/> {buildTitle}</h2>
          <p className="text-neutral-400 text-sm">Follow the steps. The form changes with your day type.</p>

          {/* STRENGTH VIEW */}
          {dayKind === "Strength" && (
            <div className="mt-4 space-y-4">
              {/* Step 2: Main Lift */}
              <div className="grid md:grid-cols-4 gap-3">
                <div className="flex flex-col gap-1">
                  <label className="text-xs text-neutral-400">Step 2 — Pick your main pattern</label>
                  <select value={pattern} onChange={(e) => setPattern(e.target.value)} className="bg-neutral-800 rounded-xl px-3 py-2">
                    {["Hinge", "Squat", "Oly", "None"].map(p => <option key={p} value={p}>{p}</option>)}
                  </select>
                </div>
                <div className="md:col-span-2 flex flex-col gap-1">
                  <label className="text-xs text-neutral-400">Choose a top movement</label>
                  <select value={movement} onChange={(e)=>setMovement(e.target.value)} disabled={!(pattern in TOP3)} className="bg-neutral-800 rounded-xl px-3 py-2">
                    {(pattern in TOP3 ? TOP3[pattern] : [""]).map(m => <option key={m} value={m}>{m}</option>)}
                  </select>
                </div>
                <div className="flex flex-col gap-1">
                  <label className="text-xs text-neutral-400">Rest between sets (min)</label>
                  <input type="number" min={2} max={5} step={0.5} value={restMin} onChange={(e)=>setRestMin(Number(e.target.value))} className="bg-neutral-800 rounded-xl px-3 py-2" placeholder="Rest (min)" />
                </div>
              </div>

              {/* Step 3: Log work sets */}
              <div className="rounded-xl bg-neutral-800/40 p-3">
                <div className="flex items-center justify-between mb-2">
                  <div className="font-semibold text-neutral-200">Step 3 — Log Work Sets</div>
                  <div className="text-xs text-neutral-400">Keep compounds 1–3 RIR · Target RPE
                    <input type="number" min={5} max={10} step={0.5} value={rpe} onChange={(e)=>setRpe(Number(e.target.value))} className="bg-neutral-800 rounded-md px-2 py-1 w-16 inline-block ml-1"/>
                  </div>
                </div>
                <div className="grid gap-2">
                  {workSets.map((s, i) => (
                    <div key={i} className="grid grid-cols-12 gap-2 items-center">
                      <div className="col-span-5 md:col-span-6 text-sm text-neutral-300 truncate">Set {i+1} — {movement || pattern}</div>
                      <input type="number" min={1} step={1} value={s.reps} onChange={(e)=>setSetField(i, 'reps', e.target.value)} className="col-span-2 bg-neutral-800 rounded-lg px-2 py-2" placeholder="Reps" />
                      <input type="number" min={0} step={1} value={s.load} onChange={(e)=>setSetField(i, 'load', e.target.value)} className="col-span-3 bg-neutral-800 rounded-lg px-2 py-2" placeholder="Weight" />
                      <button onClick={()=>removeWorkSet(i)} className="col-span-2 md:col-span-1 p-2 rounded-lg bg-neutral-800 hover:bg-neutral-700" aria-label="Remove set"><X className="h-4 w-4"/></button>
                    </div>
                  ))}
                </div>
                <div className="mt-3 flex items-center justify-between">
                  <button onClick={addWorkSet} className="text-sm px-3 py-1.5 rounded-xl bg-neutral-800 hover:bg-neutral-700">+ Add Set</button>
                  <div className="text-sm text-neutral-300">Hard sets counted: <span className="font-semibold">{hardSetCount}</span></div>
                </div>
              </div>

              {/* Optional Step 4: Finisher WOD */}
              <div className="rounded-xl bg-neutral-800/30 p-3">
                <div className="flex items-center justify-between">
                  <div className="font-semibold text-neutral-200">Step 4 (Optional) — Add a short finisher WOD</div>
                  <button onClick={()=>setWodEnabled(!wodEnabled)} className="text-sm px-3 py-1.5 rounded-xl bg-neutral-800 hover:bg-neutral-700">{wodEnabled?"Remove WOD":"+ Add WOD"}</button>
                </div>
                {wodEnabled && (
                  <WodBuilder {...{wodStyle, setWodStyle, wodName, setWodName, wodCap, setWodCap, wodRounds, setWodRounds, wodEmomMin, setWodEmomMin, wodMovements, setWodMove, addWodMove, removeWodMove, loadTemplate}} chips={QUICK_CHIPS} addChipMove={addChipMove} />
                )}
              </div>
            </div>
          )}

          {/* ENDURANCE VIEW */}
          {dayKind === "Endurance" && (
            <div className="mt-4 space-y-4">
              <div className="grid md:grid-cols-2 gap-3">
                <div className="rounded-xl bg-neutral-800/40 p-3">
                  <div className="font-semibold text-neutral-200 mb-2">Steady Endurance</div>
                  <div className="grid grid-cols-2 gap-3">
                    <div className="flex flex-col gap-1">
                      <label className="text-xs text-neutral-400">Modality</label>
                      <select value={modality} onChange={(e) => setModality(e.target.value)} className="bg-neutral-800 rounded-xl px-3 py-2">
                        {["Row", "Bike", "Run", "Ruck", "Other"].map(m => <option key={m} value={m}>{m}</option>)}
                      </select>
                    </div>
                    <div className="flex flex-col gap-1">
                      <label className="text-xs text-neutral-400">Zone 2 minutes</label>
                      <input type="number" min={0} step={5} value={zone2Min} onChange={(e)=>setZone2Min(Number(e.target.value))} className="bg-neutral-800 rounded-xl px-3 py-2" placeholder="e.g., 30" />
                    </div>
                  </div>
                  <p className="text-xs text-neutral-500 mt-2">Aim 30–40′ Z2; build toward 150′/wk.</p>
                </div>

                <div className="rounded-xl bg-neutral-800/40 p-3">
                  <div className="flex items-center justify-between">
                    <div className="font-semibold text-neutral-200">Optional: Add a WOD</div>
                    <button onClick={()=>setWodEnabled(!wodEnabled)} className="text-sm px-3 py-1.5 rounded-xl bg-neutral-800 hover:bg-neutral-700">{wodEnabled?"Remove WOD":"+ Add WOD"}</button>
                  </div>
                  {wodEnabled && (
                    <WodBuilder {...{wodStyle, setWodStyle, wodName, setWodName, wodCap, setWodCap, wodRounds, setWodRounds, wodEmomMin, setWodEmomMin, wodMovements, setWodMove, addWodMove, removeWodMove, loadTemplate}} chips={QUICK_CHIPS} addChipMove={addChipMove} />
                  )}
                </div>
              </div>

              <div>
                <label className="text-xs text-neutral-400">Notes</label>
                <input type="text" value={notes} onChange={(e)=>setNotes(e.target.value)} placeholder="HR avg, pace, terrain…" className="bg-neutral-800 rounded-xl px-3 py-2 w-full" />
              </div>
            </div>
          )}

          {/* GPP GOOD VIEW */}
          {dayKind === "GPP Good" && (
            <div className="mt-4 space-y-4">
              <div className="rounded-xl bg-neutral-800/40 p-3">
                <div className="flex items-center justify-between">
                  <div className="font-semibold text-neutral-200">Primary: Build a WOD</div>
                </div>
                <WodBuilder {...{wodStyle, setWodStyle, wodName, setWodName, wodCap, setWodCap, wodRounds, setWodRounds, wodEmomMin, setWodEmomMin, wodMovements, setWodMove, addWodMove, removeWodMove, loadTemplate}} chips={QUICK_CHIPS} addChipMove={addChipMove} />
              </div>
              <p className="text-xs text-neutral-500">Tip: Prefer row/bike in mixed pieces if you squatted or pulled heavy this week.</p>
            </div>
          )}

          {/* GPP BAD VIEW */}
          {dayKind === "GPP Bad" && (
            <div className="mt-4 space-y-4">
              <div className="rounded-xl bg-neutral-800/40 p-3">
                <div className="font-semibold text-neutral-200 mb-2">Minimum-viable session (keep it moving)</div>
                <p className="text-sm text-neutral-400 mb-3">I preloaded an easy 12′ AMRAP. Change reps/load if needed, then go. Ignore time standards if you want—just move.</p>
                <WodBuilder {...{wodStyle, setWodStyle, wodName, setWodName, wodCap, setWodCap, wodRounds, setWodRounds, wodEmomMin, setWodEmomMin, wodMovements, setWodMove, addWodMove, removeWodMove, loadTemplate}} chips={QUICK_CHIPS.slice(0,6)} addChipMove={addChipMove} />
              </div>
              <div className="rounded-xl bg-neutral-800/30 p-3">
                <div className="text-sm text-neutral-300">Optional cool-down: 5–10′ gentle row/bike + light stretch.</div>
              </div>
            </div>
          )}

          {/* RECOVERY VIEW */}
          {dayKind === "Recovery" && (
            <div className="mt-4 space-y-4">
              <div className="rounded-xl bg-neutral-800/40 p-3">
                <div className="font-semibold text-neutral-200 mb-2">Low-impact Recovery</div>
                <div className="grid md:grid-cols-3 gap-3">
                  <div className="flex flex-col gap-1">
                    <label className="text-xs text-neutral-400">Walk minutes</label>
                    <input type="number" min={0} step={5} value={zone2Min} onChange={(e)=>setZone2Min(Number(e.target.value))} className="bg-neutral-800 rounded-xl px-3 py-2" placeholder="30–60" />
                    <span className="text-[10px] text-neutral-500 mt-1">Counts as Zone 2 if brisk.</span>
                  </div>
                  <div className="flex flex-col gap-1">
                    <label className="text-xs text-neutral-400">Mobility (min)</label>
                    <input type="number" min={0} step={5} value={wodEmomMin} onChange={(e)=>setWodEmomMin(Number(e.target.value))} className="bg-neutral-800 rounded-xl px-3 py-2" placeholder="10–20" />
                  </div>
                  <div className="flex flex-col gap-1">
                    <label className="text-xs text-neutral-400">Yoga / Breathing (min)</label>
                    <input type="number" min={0} step={5} value={wodCap} onChange={(e)=>setWodCap(Number(e.target.value))} className="bg-neutral-800 rounded-xl px-3 py-2" placeholder="10–20" />
                  </div>
                </div>
                <p className="text-xs text-neutral-500 mt-2">No resistance work today. Keep it easy.</p>
              </div>
              <div>
                <label className="text-xs text-neutral-400">Notes</label>
                <input type="text" value={notes} onChange={(e)=>setNotes(e.target.value)} placeholder="How you felt, tight spots, etc." className="bg-neutral-800 rounded-xl px-3 py-2 w-full" />
              </div>
            </div>
          )}

          {/* Accessories (auto-planned) — hidden on Recovery; lighter bias on GPP Bad */}
          {dayKind !== "Recovery" && (
            <div className="mt-6">
              <div className="flex items-center justify-between mb-2">
                <h3 className="font-semibold text-neutral-200">Accessories</h3>
                <div className="flex items-center gap-2">
                  <div className="hidden sm:flex items-center gap-2">
                    <select value={newAcc.target} onChange={(e)=>setNewAcc(p=>({...p, target:e.target.value}))} className="bg-neutral-800 rounded-lg px-2 py-1 text-sm">
                      {Object.keys(POOLS).map(t => <option key={t} value={t}>{t}</option>)}
                    </select>
                    <input value={newAcc.name} onChange={(e)=>setNewAcc(p=>({...p, name:e.target.value}))} placeholder="Accessory name" className="bg-neutral-800 rounded-lg px-2 py-1 text-sm w-36"/>
                    <input value={newAcc.load} onChange={(e)=>setNewAcc(p=>({...p, load:e.target.value}))} placeholder="Weight" className="bg-neutral-800 rounded-lg px-2 py-1 text-sm w-24"/>
                    <button onClick={addManualAccessory} className="text-sm px-2 py-1.5 rounded-xl bg-neutral-800 hover:bg-neutral-700">+ Add</button>
                  </div>
                  <button onClick={autoAddAccessory} className="text-sm px-3 py-1.5 rounded-xl bg-neutral-800 hover:bg-neutral-700">+ Recommend</button>
                </div>
              </div>
              <div className="grid gap-3">
                {accessories.length === 0 && (
                  <p className="text-neutral-400 text-sm">Hypertrophy defaults: big muscles <b>3×8–12</b>, arms <b>3×10–15</b>, calves/tib <b>3×12–20</b>. Add weight and go 1–3 RIR.</p>
                )}
                {accessories.map(a => (
                  <div key={a.id} className="grid md:grid-cols-6 gap-2 bg-neutral-800/60 rounded-xl p-3 items-center">
                    <div className="md:col-span-2">
                      <div className="font-semibold">{a.name}</div>
                      <div className="text-xs text-neutral-400">{a.target}</div>
                    </div>
                    <div>
                      <label className="text-xs text-neutral-400">Sets</label>
                      <input type="number" min={2} max={5} value={a.sets} onChange={(e)=>setAccessories(prev=>prev.map(x=>x.id===a.id?{...x,sets:Number(e.target.value)}:x))} className="bg-neutral-800 rounded-lg px-2 py-2 w-full" />
                    </div>
                    <div>
                      <label className="text-xs text-neutral-400">Reps</label>
                      <input type="number" min={6} max={25} value={a.reps} onChange={(e)=>setAccessories(prev=>prev.map(x=>x.id===a.id?{...x,reps:Number(e.target.value)}:x))} className="bg-neutral-800 rounded-lg px-2 py-2 w-full" />
                    </div>
                    <div>
                      <label className="text-xs text-neutral-400">Weight</label>
                      <input type="number" min={0} step={1} value={a.load ?? ""} onChange={(e)=>setAccessories(prev=>prev.map(x=>x.id===a.id?{...x,load:e.target.value}:x))} className="bg-neutral-800 rounded-lg px-2 py-2 w-full" placeholder="lbs/kg" />
                    </div>
                    <div className="flex justify-end">
                      <button onClick={()=>removeAccessory(a.id)} className="p-2 rounded-lg bg-neutral-800 hover:bg-neutral-700 self-end" aria-label="Remove accessory"><X className="h-4 w-4"/></button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          <div className="mt-6 flex items-center justify-between">
            <button onClick={saveSession} className="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-emerald-700 hover:bg-emerald-600">
              <CheckCircle2 className="h-5 w-5"/> Save Session
            </button>
            <div className="text-neutral-400 text-sm flex items-center gap-2"><Clock3 className="h-4 w-4"/> Rest compounds ≥2–3′ · Accessories 60–90s · WOD minutes auto-count toward vigorous</div>
          </div>
        </motion.div>

        {/* Weekly Dashboard */}
        <motion.div layout className="rounded-2xl bg-neutral-900 p-5 shadow-sm border border-neutral-800">
          <h2 className="text-lg font-semibold flex items-center gap-2"><TrendingUp className="h-5 w-5"/> Weekly Dashboard</h2>
          <div className="grid md:grid-cols-3 gap-4 mt-4">
            <div className="bg-neutral-800/40 rounded-2xl p-4">
              <p className="text-sm text-neutral-400 mb-2">Lower Body Sets</p>
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-2xl font-bold">Quads {totals.quadsSets}</div>
                  <div className="text-xs text-neutral-400">Target ≥ {TARGETS.Quads}</div>
                </div>
                {quadsOk ? badge("bg-emerald-900/30 text-emerald-300","On track") : badge("bg-amber-900/30 text-amber-300","Low")}
              </div>
              <div className="flex items-center justify-between mt-3">
                <div>
                  <div className="text-2xl font-bold">Posterior {totals.posteriorSets}</div>
                  <div className="text-xs text-neutral-400">Target ≥ {TARGETS.Posterior}</div>
                </div>
                {posteriorOk ? badge("bg-emerald-900/30 text-emerald-300","On track") : badge("bg-amber-900/30 text-amber-300","Low")}
              </div>
            </div>

            <div className="bg-neutral-800/40 rounded-2xl p-4">
              <p className="text-sm text-neutral-400 mb-2">Upper Body Sets</p>
              <div className="grid grid-cols-2 gap-3 text-sm">
                <div>Chest <span className="font-semibold">{totals.chestSets}</span></div>
                <div>Back <span className="font-semibold">{totals.backSets}</span></div>
                <div>Delts <span className="font-semibold">{totals.deltSets}</span></div>
                <div>Arms <span className="font-semibold">{totals.armSets}</span></div>
              </div>
              <p className="text-xs text-neutral-400 mt-2">Targets — Chest 10, Back 12, Delts 10, Arms 8 hard sets/wk.</p>
            </div>

            <div className="bg-neutral-800/40 rounded-2xl p-4">
              <p className="text-sm text-neutral-400 mb-2">Endurance Minutes</p>
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-2xl font-bold">Z2 {totals.zone2Min}′</div>
                  <div className="text-xs text-neutral-400">Target ≥150′ (or Vig ≥75′)</div>
                </div>
                <div>
                  <div className="text-2xl font-bold">Vig {totals.vigorousMin}′</div>
                  <div className="text-xs text-neutral-400">Target ≥75′ (or mixed equiv)</div>
                </div>
              </div>
              <div className="mt-2">{enduranceOk ? badge("bg-emerald-900/30 text-emerald-300","On track") : badge("bg-amber-900/30 text-amber-300","Low this week")}</div>
            </div>
          </div>

          <div className="grid md:grid-cols-3 gap-4 mt-4">
            <div className="bg-neu
