<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hybrid Trainer — Clean v11</title>
<meta name="theme-color" content="#0b0b0c" />
<style>
  :root { --bg:#0b0b0c; --card:#141416; --muted:#9aa0a6; --text:#e7e9ea; --accent:#1db954; --warn:#f59e0b; --danger:#ef4444; --line:#24262a; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
  .wrap{max-width:1120px;margin:24px auto;padding:0 16px}
  h1{font-size:24px;margin:0 0 6px}
  h2{font-size:18px;margin:0 0 8px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:900px){.row{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .muted{color:var(--muted)} .small{font-size:12px}
  .btn{background:#1f2937;color:#fff;border:none;border-radius:12px;padding:8px 12px;cursor:pointer}
  .btn:hover{background:#2a3648}
  .btn.bad{background:#2a1b1b}.btn.bad:hover{background:#3a2222}
  .btn.green{background:#176b3d}.btn.green:hover{background:#1b7d47}
  .pill{display:inline-block;background:#1f2937;color:#d1fae5;border-radius:999px;padding:4px 8px;font-size:12px}
  .pill.ok{background:rgba(16,185,129,.15);color:#34d399}
  .pill.warn{background:rgba(245,158,11,.15);color:#f59e0b}
  .grid{display:grid;gap:8px}
  .g2{grid-template-columns:1fr 1fr}.g3{grid-template-columns:repeat(3,1fr)}.g4{grid-template-columns:repeat(4,1fr)}
  input[type=number],input[type=text],select{width:100%;background:#1f2227;border:1px solid #2a2d33;color:#e7e9ea;border-radius:10px;padding:8px}
  input[type=range]{width:100%}
  .flex{display:flex;gap:8px;align-items:center}
  .space{justify-content:space-between}
  .list{max-height:180px;overflow:auto;border-top:1px solid var(--line);margin-top:8px;padding-top:8px}
  .line{height:1px;background:var(--line);margin:10px 0}
  label.small{display:flex;flex-direction:column;gap:4px}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#1f2937;color:#e7e9ea;border:1px solid #2a2d33;border-radius:12px;padding:8px 12px;opacity:0;pointer-events:none;transition:opacity .2s;z-index:9999}
  .toast.show{opacity:1}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #2b2e35;padding:6px 8px;text-align:left}
  th{background:#1a1d22;font-weight:600}
  td input{width:100%}
  .tag{font-size:11px;color:#93c5fd;background:#0b1b30;border:1px solid #173152;border-radius:999px;padding:2px 6px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="space flex">
      <div>
        <h1>Hybrid Trainer — Clean v11</h1>
        <div class="muted small">Single HTML. Local save + export/import. No service worker.</div>
      </div>
      <div class="flex">
        <button id="exportBtn" class="btn">Export</button>
        <label class="btn"><input id="importFile" type="file" accept="application/json" style="display:none">Import</label>
        <button id="resetWeek" class="btn">Reset Week</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="card">
        <h2>Readiness</h2>
        <div class="muted small" style="margin-bottom:8px">0=Bad, 1=Fine, 2=Good. Worst days → <b>GPP Bad</b>.</div>
        <div class="grid">
          <div class="g3 grid">
            <label class="small">Sleep <input type="range" min="0" max="2" step="1" id="sleep" value="1"></label>
            <label class="small">Nutrition <input type="range" min="0" max="2" step="1" id="food" value="1"></label>
            <label class="small">Soreness <input type="range" min="0" max="2" step="1" id="sore" value="1"></label>
          </div>
          <div class="g2 grid">
            <label class="small">Mood <input type="range" min="0" max="2" step="1" id="mood" value="1"></label>
            <label class="small">Morning BW <input type="number" inputmode="numeric" pattern="[0-9]*" id="bw" placeholder="lbs/kg"></label>
          </div>
          <div><label class="small">Sleep (hrs) <input type="number" inputmode="numeric" pattern="[0-9]*" id="sleepHrs" min="0" step="0.5"></label></div>
        </div>
      </div>

      <div class="card">
        <h2>Recommendation</h2>
        <div class="flex" style="flex-wrap:wrap;gap:6px 8px;margin-bottom:8px">
          <span id="recoPill" class="pill">—</span>
          <span id="recoHint" class="pill"></span>
        </div>
        <div class="g2 grid">
          <label class="small">Day type
            <select id="dayKind">
              <option>Strength</option>
              <option>Endurance</option>
              <option>GPP Good</option>
              <option>GPP Bad</option>
              <option>Recovery</option>
            </select>
          </label>
          <label class="small" id="modWrap" style="display:none">Endurance Modality
            <select id="modality">
              <option>Row</option><option>Bike</option><option>Run</option><option>Ruck</option><option>Swim</option><option>Other</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2 id="buildTitle">Build Today’s Session</h2>
      <div class="muted small">Per-set <b>Fail</b> = only mark if technique blows up or you truly failed. Otherwise it counts.</div>

      <!-- Strength -->
      <div id="strengthView" style="display:none">
        <div class="line"></div>
        <div class="g4 grid">
          <label class="small">Pattern
            <select id="pattern">
              <option>Hinge</option><option>Squat</option><option>Oly</option><option>None</option>
            </select>
          </label>
          <label class="small">Movement (top 3)
            <select id="movement"></select>
          </label>
          <label class="small">Rest (min)<input type="number" inputmode="numeric" pattern="[0-9]*" id="restMin" min="2" max="5" step="0.5" value="3"></label>
          <label class="small">Target RPE<input type="number" inputmode="numeric" pattern="[0-9]*" id="rpe" min="5" max="10" step="0.5" value="8"></label>
        </div>
        <div class="small muted" id="progGhost" style="margin-top:6px"></div>

        <div class="card" style="margin-top:10px">
          <div class="space flex">
            <div><b>Main Lifts</b> <span class="muted small">Enter each work set</span></div>
            <div class="small">Hard sets: <b id="hardCount">0</b></div>
          </div>
          <div style="overflow:auto">
            <table id="setsTable">
              <thead>
                <tr><th>#</th><th>Movement</th><th>Reps</th><th>Weight</th><th>RPE</th><th>Fail</th><th></th></tr>
              </thead>
              <tbody id="setsBody"></tbody>
            </table>
          </div>
          <div style="margin-top:8px" class="flex">
            <button class="btn" id="addSet">+ Add Set</button>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <div class="space flex">
            <div><b>Optional Finisher WOD</b></div>
            <button class="btn" id="toggleWod">+ Add WOD</button>
          </div>
          <div id="wodWrap" style="display:none;margin-top:8px"></div>
        </div>
      </div>

      <!-- Endurance -->
      <div id="enduranceView" style="display:none">
        <div class="line"></div>
        <div class="g3 grid">
          <label class="small">Duration (min)<input id="z2" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="5" value="30"></label>
          <label class="small">Distance<input id="dist" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="0.1" placeholder="5"></label>
          <label class="small">Unit<select id="distUnit"><option>mi</option><option>km</option></select></label>
        </div>
        <div class="g3 grid" style="margin-top:6px">
          <label class="small" id="ruckWrap" style="display:none">Ruck weight<input id="ruckWeight" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="1" placeholder="lbs"></label>
          <div></div><div></div>
        </div>
        <div class="card" style="margin-top:10px">
          <div class="space flex">
            <div><b>Optional WOD</b></div>
            <button class="btn" id="toggleWod2">+ Add WOD</button>
          </div>
          <div id="wodWrap2" style="display:none;margin-top:8px"></div>
        </div>
        <div style="margin-top:8px"><label class="small">Notes<input id="notes" type="text" placeholder="HR, pace, terrain…"></label></div>
      </div>

      <!-- GPP Good -->
      <div id="gppGoodView" style="display:none">
        <div class="line"></div>
        <div class="card">
          <div><b>Build a WOD</b></div>
          <div id="wodWrap3" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- GPP Bad -->
      <div id="gppBadView" style="display:none">
        <div class="line"></div>
        <div class="card">
          <div><b>Minimum viable session</b> <span class="muted small">12′ AMRAP: Air Squat / Push-Up / Dead Hang</span></div>
          <div id="wodWrap4" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- Recovery -->
      <div id="recoveryView" style="display:none">
        <div class="line"></div>
        <div class="g3 grid">
          <label class="small">Walk (min)<input id="walkMin" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="5" value="30"></label>
          <label class="small">Mobility (min)<input id="mobMin" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="5" value="10"></label>
          <label class="small">Yoga/Breath (min)<input id="yogaMin" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="5" value="10"></label>
        </div>
        <div style="margin-top:8px"><label class="small">Notes<input id="notesRec" type="text" placeholder="How you felt…"></label></div>
      </div>

      <div class="line"></div>

      <!-- Accessories -->
      <div id="accWrap">
        <div class="space flex">
          <h3 style="margin:0">Accessories</h3>
          <div class="flex" style="flex-wrap:wrap;gap:6px 8px">
            <select id="newAccTarget">
              <option>Back</option><option>Chest</option><option>Delts</option><option>Arms</option>
              <option>Quads</option><option>Posterior</option><option>Calves</option><option>Tib</option>
              <option>Core</option>
            </select>
            <input id="newAccName" type="text" placeholder="Accessory name">
            <input id="newAccLoad" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="1" placeholder="Weight or plate">
            <button class="btn" id="addManualAcc">+ Add</button>
          </div>
        </div>
        <div class="muted small" id="accHelp" style="margin-top:6px">
          Defaults: big groups <b>3×8–12</b>, arms <b>3×10–15</b>, calves/tib/core <b>3×12–20</b>. 1–3 RIR.
        </div>
        <div id="accList" class="grid" style="margin-top:8px"></div>
      </div>

      <div class="space flex" style="margin-top:12px">
        <button class="btn green" id="saveBtn">Save Session</button>
        <div class="muted small">Compounds rest ≥2–3′ · Accessories 60–90s · WOD time counts as vigorous</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2>Weekly Dashboard</h2>
      <div class="row">
        <div class="card">
          <div class="space flex"><div>Lower Body Sets</div></div>
          <div class="grid">
            <div>Quads: <b id="qSets">0</b> <span id="qStatus" class="pill"></span></div>
            <div>Posterior: <b id="pSets">0</b> <span id="pStatus" class="pill"></span></div>
            <div class="muted small">Targets — Quads ≥10 · Posterior ≥10</div>
          </div>
        </div>
        <div class="card">
          <div>Upper/Other Sets</div>
          <div class="g2 grid" style="margin-top:6px">
            <div>Chest <b id="cSets">0</b></div><div>Back <b id="bSets">0</b></div>
            <div>Delts <b id="dSets">0</b></div><div>Arms <b id="aSets">0</b></div>
          </div>
          <div style="margin-top:6px">Core <b id="coreSets">0</b> <span id="coreStatus" class="pill"></span></div>
          <div class="muted small" style="margin-top:6px">Targets — Chest 10 · Back 12 · Delts 10 · Arms 8 · Core 8</div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <div class="card">
          <div>Endurance Minutes</div>
          <div class="g2 grid" style="margin-top:6px">
            <div>Z2 <b id="z2Min">0′</b></div><div>Vig <b id="vigMin">0′</b></div>
          </div>
          <div id="endStatus" class="pill" style="margin-top:6px"></div>
        </div>
        <div class="card">
          <div>History (This Week)</div>
          <div id="hist" class="list"></div>
        </div>
      </div>
      <div class="muted small" style="margin-top:8px;text-align:center">
        Clean build v11 — no PWA cache.
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ================= Versions & Storage ================= */
const APP_VERSION = 11;
const STORE_KEY = "hybrid_v11";

/* ================= Utilities ================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = () => Math.random().toString(36).slice(2,9);
const todayISO = () => { const d=new Date(); d.setHours(0,0,0,0); return d.toISOString(); };
const weekKey = (()=>{ const d=new Date(), onejan=new Date(d.getFullYear(),0,1); const w=Math.ceil((((d-onejan)/86400000)+onejan.getDay()+1)/7); return `${d.getFullYear()}-W${String(w).padStart(2,"0")}`; })();
function load(k,f){ try{ const s=localStorage.getItem(k); return s?JSON.parse(s):f }catch{ return f } }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 2000); }
function badge(el, ok, onTxt="On track", offTxt="Low"){ el.className = "pill " + (ok ? "ok" : "warn"); el.textContent = ok ? onTxt : offTxt; }

/* ================= Data ================= */
let store = load(STORE_KEY, { version: APP_VERSION, weeks: {} });
function week(){ if(!store.weeks[weekKey]) store.weeks[weekKey] = { sessions: [], recovery: [] }; return store.weeks[weekKey]; }
function saveStore(){ save(STORE_KEY, store); }

/* ================= Targets ================= */
const TARGETS = { Quads:10, Posterior:10, Chest:10, Back:12, Delts:10, Arms:8, Core:8 };

/* ================= UI Refs ================= */
const sleep = $("#sleep"), food=$("#food"), sore=$("#sore"), mood=$("#mood");
const bw=$("#bw"), sleepHrs=$("#sleepHrs");
const recoPill = $("#recoPill"), recoHint=$("#recoHint");
const dayKind = $("#dayKind"), modWrap=$("#modWrap"), modality=$("#modality");

const strengthView = $("#strengthView"),
      enduranceView = $("#enduranceView"),
      gppGoodView  = $("#gppGoodView"),
      gppBadView   = $("#gppBadView"),
      recoveryView = $("#recoveryView");

const pattern  = $("#pattern"),
      movement = $("#movement"),
      restMin  = $("#restMin"),
      rpe      = $("#rpe");

const setsBody = $("#setsBody"),
      addSetBtn = $("#addSet"),
      hardCount = $("#hardCount"),
      progGhost = $("#progGhost");

const toggleWod  = $("#toggleWod"),
      wodWrap    = $("#wodWrap"),
      toggleWod2 = $("#toggleWod2"),
      wodWrap2   = $("#wodWrap2"),
      wodWrap3   = $("#wodWrap3"),
      wodWrap4   = $("#wodWrap4");

const accList       = $("#accList"),
      newAccTarget  = $("#newAccTarget"),
      newAccName    = $("#newAccName"),
      newAccLoad    = $("#newAccLoad");

/* ================= Recommendation ================= */
function recommend(s,f,so,m){ const n=(s+f+so+m)/8; if(n>=0.82) return "Strength"; if(n>=0.65) return "GPP Good"; if(n>=0.48) return "Endurance"; return "GPP Bad"; }
const numVal = el => { const n = Number(el?.value); return Number.isFinite(n)?n:1; };

function updateReco(){
  const r = recommend(numVal(sleep),numVal(food),numVal(sore),numVal(mood));
  if(!dayKind.__manualPick) dayKind.value = r;
  recoPill.textContent = r;
  recoHint.textContent = r==="Strength"?"Long rests · 3–6 reps · RPE 7–9":(r==="Endurance"?"30–40′ Z2 preferred":"");
  adaptBuilder();
}
["input","change"].forEach(evt=>{ [sleep,food,sore,mood].forEach(el=> el.addEventListener(evt, updateReco)); });
dayKind.addEventListener("change", ()=>{ dayKind.__manualPick = true; adaptBuilder(); });
["input","change"].forEach(evt=>{ [sleep,food,sore,mood].forEach(el=> el.addEventListener(evt, ()=> dayKind.__manualPick=false)); });

/* ================= Strength Main Lifts ================= */
const TOP3 = {
  Hinge:["Conventional Deadlift","Trap Bar Deadlift","Romanian Deadlift"],
  Squat:["Back Squat","Front Squat","Pause Back Squat"],
  Oly:["Clean & Jerk","Clean","Snatch"],
  None:["—"]
};
function renderTop3(){
  const list = TOP3[pattern.value] || ["—"];
  movement.innerHTML = list.map(x=>`<option>${x}</option>`).join("");
  progGhost.textContent="";
}
pattern.addEventListener("change", renderTop3);

function addSetRow(vals={ reps:"", load:"", rpe:"", fail:false }){
  const tr = document.createElement("tr");
  const idx = setsBody.children.length + 1;
  tr.innerHTML = `
    <td><span class="tag">Set ${idx}</span></td>
    <td>${movement.value || pattern.value}</td>
    <td><input type="number" min="1" step="1" value="${vals.reps}"></td>
    <td><input type="number" min="0" step="1" value="${vals.load}"></td>
    <td><input type="number" min="5" max="10" step="0.5" value="${vals.rpe}"></td>
    <td style="text-align:center"><input type="checkbox" ${vals.fail?"checked":""}></td>
    <td><button class="btn bad">X</button></td>`;
  const [_,__,reps,load,rpe,fail,del] = tr.children;
  const delBtn = del.querySelector("button");
  delBtn.addEventListener("click", ()=>{ tr.remove(); recountHardSets(); refreshSetNumbers(); });
  [reps.querySelector("input"),load.querySelector("input"),rpe.querySelector("input"),fail.querySelector("input")].forEach(inp=> inp.addEventListener("input", ()=>{ recountHardSets(); updateProgHint(); }));
  setsBody.appendChild(tr);
  recountHardSets(); updateProgHint();
}
function refreshSetNumbers(){
  [...setsBody.children].forEach((tr,i)=>{ tr.firstElementChild.innerHTML = `<span class="tag">Set ${i+1}</span>`; });
}
function recountHardSets(){
  let count=0;
  [...setsBody.querySelectorAll("tr")].forEach(tr=>{
    const reps=Number(tr.children[2].querySelector("input").value||0);
    const load=Number(tr.children[3].querySelector("input").value||0);
    const fail=tr.children[5].querySelector("input").checked;
    if(reps>0 && load>0 && !fail) count++;
  });
  hardCount.textContent = count;
}
function updateProgHint(){
  const good=[];
  [...setsBody.querySelectorAll("tr")].forEach(tr=>{
    const reps=Number(tr.children[2].querySelector("input").value||0);
    const load=Number(tr.children[3].querySelector("input").value||0);
    const rpe=Number(tr.children[4].querySelector("input").value||0);
    const fail=tr.children[5].querySelector("input").checked;
    if(!fail && rpe>0 && rpe<=9.5 && reps>0 && load>0){ good.push({reps,load}); }
  });
  if(!good.length){ progGhost.textContent=""; return; }
  const best = Math.max(...good.map(s=> s.load*(1+s.reps/30)));
  const upper = ["Bench","Press","Row","Pulldown","Pull-Up","DB"].some(k=> (movement.value||"").includes(k));
  progGhost.textContent = upper ? "Next: push reps toward 10–12 before adding load" : "Next: +2.5–5 lb if ≤8 RPE at target reps";
}
addSetBtn.addEventListener("click", ()=> addSetRow());

/* ================= WOD Builder (simple) ================= */
function buildWodUI(container, preset){
  container.innerHTML = `
    <div class="g4 grid">
      <label class="small">Style
        <select class="w-style"><option>AMRAP</option><option>For Time</option><option>EMOM</option><option>Intervals</option><option>Chipper</option></select>
      </label>
      <label class="small">Name (optional)<input class="w-name" type="text" placeholder="e.g., 4RFT Row/Wall Ball/Sit-Up"></label>
      <label class="small">Time (min)<input class="w-cap" type="number" min="0" step="1" value="20"></label>
      <label class="small">Rounds<input class="w-rounds" type="number" min="1" step="1" value="${preset==='bad'?1:3}"></label>
    </div>
    <div class="line"></div>
    <div class="space flex"><div><b>Movements</b></div><button class="btn w-add">+ Add Movement</button></div>
    <div class="w-list grid" style="margin-top:6px"></div>
    <div class="muted small" style="margin-top:6px">Mark BW if body-weight.</div>`;
  const add = container.querySelector(".w-add");
  const list = container.querySelector(".w-list");
  function addMove(nameV="", repsV="", loadV="", bw=false){
    const row = document.createElement("div");
    row.className="grid g4";
    row.innerHTML=`
      <input placeholder="Movement (e.g., KB Swing)" value="${nameV}">
      <input placeholder="Reps/Time (e.g., 15 or 30s)" value="${repsV}">
      <input placeholder="Load (e.g., 24kg or light)" value="${loadV}">
      <div class="flex" style="justify-content:space-between">
        <label class="small" style="flex-direction:row;gap:8px;align-items:center"><input class="w-bw" type="checkbox" ${bw?"checked":""}> BW</label>
        <button class="btn bad w-del">X</button>
      </div>`;
    row.querySelector(".w-del").addEventListener("click", ()=> row.remove());
    list.appendChild(row);
  }
  if(preset==="bad"){
    [["Air Squat","15","BW",true],["Push-Up","10","BW",true],["Dead Hang (sec)","20","BW",true]].forEach(x=>addMove(...x));
  }
  add.addEventListener("click", ()=> addMove());
  return { read(){
    const style = container.querySelector(".w-style").value;
    const name  = container.querySelector(".w-name").value.trim();
    const cap   = Number(container.querySelector(".w-cap").value||0);
    const rounds= Number(container.querySelector(".w-rounds").value||1);
    const moves=[...container.querySelectorAll(".w-list > div")].map(row=>{
      const [n,r,l] = row.querySelectorAll("input");
      const bw = row.querySelector(".w-bw")?.checked || false;
      return {name:n.value.trim(), reps:r.value.trim(), load:l.value.trim(), bw};
    }).filter(m=>m.name);
    return {style,name,cap,rounds,moves};
  }};
}
let wodUI=null, wodUI2=null, wodUI3=null, wodUI4=null;

$("#toggleWod").addEventListener("click", ()=>{
  if(wodWrap.style.display==="none"){ wodWrap.style.display=""; wodUI = buildWodUI(wodWrap); $("#toggleWod").textContent="Remove WOD"; }
  else { wodWrap.style.display="none"; wodWrap.innerHTML=""; $("#toggleWod").textContent="+ Add WOD"; wodUI=null; }
});
$("#toggleWod2").addEventListener("click", ()=>{
  if(wodWrap2.style.display==="none"){ wodWrap2.style.display=""; wodUI2 = buildWodUI(wodWrap2); $("#toggleWod2").textContent="Remove WOD"; }
  else { wodWrap2.style.display="none"; wodWrap2.innerHTML=""; $("#toggleWod2").textContent="+ Add WOD"; wodUI2=null; }
});

/* ================= Accessories ================= */
let accessories=[];
function addAccessory(target,name,sets,reps,load=""){
  const id = uid();
  const row = document.createElement("div");
  row.className = "grid g4"; row.style.gridTemplateColumns="2fr 1fr 1fr 1fr auto";
  row.dataset.id = id;
  row.innerHTML = `<div><b>${name}</b><div class="muted small">${target}</div></div>
    <label class="small">Sets<input type="number" min="2" max="5" value="${sets}"></label>
    <label class="small">Reps<input type="number" min="6" max="25" value="${reps}"></label>
    <label class="small">Weight<input type="number" min="0" step="1" placeholder="Weight" value="${load}"></label>
    <button class="btn bad">X</button>`;
  $("#accList").appendChild(row);
  const delBtn = row.querySelector("button");
  const [setsEl,repsEl,loadEl] = row.querySelectorAll("input");
  delBtn.addEventListener("click", ()=>{ row.remove(); accessories = accessories.filter(a=>a.id!==id); });
  accessories.push({id,target,name,setsEl,repsEl,loadEl});
}
$("#addManualAcc").addEventListener("click", ()=>{
  const t = newAccTarget.value || "Back";
  const name = newAccName.value.trim() || "Accessory";
  const load = newAccLoad.value || "";
  const defaults = (t==="Calves"||t==="Core")?{sets:3,reps:15} : (t==="Arms"?{sets:3,reps:12}:{sets:3,reps:10});
  addAccessory(t, name, defaults.sets, defaults.reps, load);
  newAccName.value=""; newAccLoad.value="";
});

/* ================= Session Save & Totals ================= */
function draftSession(){
  const kind = dayKind.value;
  const main = (kind==="Strength") ? {
    pattern: pattern.value,
    movement: movement.value || pattern.value,
    rpe: Number(rpe.value)||8,
    rest: Number(restMin.value)||3,
    sets: [...setsBody.querySelectorAll("tr")].filter(tr=>{
      const reps=Number(tr.children[2].querySelector("input").value||0);
      const load=Number(tr.children[3].querySelector("input").value||0);
      const fail=tr.children[5].querySelector("input").checked;
      return reps>0 && load>0 && !fail;
    }).length,
    setsDetail: [...setsBody.querySelectorAll("tr")].map(tr=>({
      reps:Number(tr.children[2].querySelector("input").value||0),
      load:Number(tr.children[3].querySelector("input").value||0),
      rpe:Number(tr.children[4].querySelector("input").value||0)||null,
      fail:tr.children[5].querySelector("input").checked
    }))
  } : null;

  let end = undefined;
  if(kind!=="Strength"){
    end = {
      z2: kind==="Endurance" ? Number($("#z2").value||0) : 0,
      vig: (wodUI||wodUI2||wodUI3||wodUI4) ? Number((wodUI||wodUI2||wodUI3||wodUI4).read().cap||0) : 0,
      modality: $("#modality")?.value || ""
    };
  }

  let wod = null;
  if(kind==="Strength" && wodUI) wod = wodUI.read();
  if(kind==="Endurance" && wodUI2) wod = wodUI2.read();
  if(kind==="GPP Good"){ if(!wodUI3) wodUI3 = buildWodUI(wodWrap3, "good"); wod = wodUI3.read(); }
  if(kind==="GPP Bad"){ if(!wodUI4) wodUI4 = buildWodUI(wodWrap4, "bad"); wod = wodUI4.read(); }

  const acc = accessories.map(a=>({target:a.target, name:a.name, sets:Number(a.setsEl.value||0), reps:Number(a.repsEl.value||0), load:a.loadEl.value}));
  return { id: uid(), date: todayISO(), kind, main, endurance: end, wod, acc, version: APP_VERSION };
}
function totalsCalc(sess){
  const t = {quads:0,post:0,chest:0,back:0,delts:0,arms:0,core:0, z2:0,vig:0, strength:0};
  (sess||[]).forEach(s=>{
    if(s.main && s.main.pattern && s.main.sets){
      const add = s.main.sets;
      if(s.main.pattern==="Squat") t.quads += add;
      if(s.main.pattern==="Hinge") t.post += add;
      if(s.main.pattern==="Oly"){ t.quads += Math.ceil(add/2); t.post += Math.floor(add/2); }
    }
    if(s.endurance){ t.z2 += s.endurance.z2||0; t.vig += s.endurance.vig||0; }
    (s.acc||[]).forEach(a=>{
      if(a.target==="Quads") t.quads += a.sets;
      if(a.target==="Posterior") t.post += a.sets;
      if(a.target==="Chest") t.chest += a.sets;
      if(a.target==="Back") t.back += a.sets;
      if(a.target==="Delts") t.delts += a.sets;
      if(a.target==="Arms") t.arms += a.sets;
      if(a.target==="Core") t.core += a.sets;
    });
    if(s.kind==="Strength") t.strength++;
  });
  return t;
}
function renderDashboard(){
  const t = totalsCalc(week().sessions);
  $("#z2Min").textContent = t.z2+"′"; $("#vigMin").textContent = t.vig+"′";
  $("#qSets").textContent = t.quads; $("#pSets").textContent = t.post;
  $("#cSets").textContent = t.chest||0; $("#bSets").textContent = t.back||0;
  $("#dSets").textContent = t.delts||0; $("#aSets").textContent = t.arms||0; $("#coreSets").textContent = t.core||0;
  badge($("#qStatus"), t.quads>=TARGETS.Quads); badge($("#pStatus"), t.post>=TARGETS.Posterior);
  badge($("#coreStatus"), t.core>=TARGETS.Core);
  const endOK = (t.z2>=150) || (t.vig>=75) || ((t.z2*0.5 + t.vig)>=75);
  badge($("#endStatus"), endOK, "On track", "Low this week");
  $("#hist").innerHTML = week().sessions.map(s=>{
    const d=new Date(s.date).toLocaleDateString();
    const tag = s.kind==="Strength" ? (s.main?.movement || s.main?.pattern) : (s.wod?.name || s.endurance?.modality || "");
    return `<div class="space flex"><span>${d} · ${s.kind}</span><span class="muted small">${tag||""}</span></div>`;
  }).join("") || '<div class="muted">No sessions yet.</div>';
}

function saveSession(){
  const s = draftSession();
  week().sessions.push(s);
  week().recovery.push({ date: todayISO(), bw: (bw.value?Number(bw.value):null), sleepHrs: (sleepHrs.value?Number(sleepHrs.value):null) });
  saveStore();
  // reset builder
  setsBody.innerHTML=""; accessories=[]; $("#accList").innerHTML="";
  if(dayKind.value==="Strength") addSetRow();
  renderDashboard();
  toast("Session saved.");
}

/* ================= Export / Import / Reset ================= */
$("#exportBtn").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(store,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`hybrid_store_${weekKey}.json`; a.click();
});
$("#importFile").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{ try{ const data = JSON.parse(r.result); if(data && data.weeks){ store = data; saveStore(); renderDashboard(); toast("Import success."); } else toast("Invalid file."); }catch{ toast("Failed to parse JSON."); } };
  r.readAsText(f);
});
$("#resetWeek").addEventListener("click", ()=>{ if(confirm("Reset this week's data?")){ store.weeks[weekKey]={sessions:[],recovery:[],version:APP_VERSION}; saveStore(); renderDashboard(); } });
$("#saveBtn").addEventListener("click", saveSession);

/* ================= Builder + Views ================= */
function adaptBuilder(){
  const k = dayKind.value;
  $("#modWrap").style.display = (k==="Endurance") ? "" : "none";
  $("#buildTitle").textContent = {
    Strength:"Build Today’s Strength Session",
    Endurance:"Build Today’s Endurance Session",
    "GPP Good":"Build Today’s GPP (Good) Session",
    "GPP Bad":"Build Today’s GPP (Bad) Session",
    Recovery:"Plan Today’s Recovery"
  }[k] || "Build Today’s Session";
  strengthView.style.display = (k==="Strength")?"":"none";
  enduranceView.style.display = (k==="Endurance")?"":"none";
  gppGoodView.style.display = (k==="GPP Good")?"":"none";
  gppBadView.style.display = (k==="GPP Bad")?"":"none";
  recoveryView.style.display = (k==="Recovery")?"":"none";
  if(k==="Strength"){ if(!movement.options.length) renderTop3(); if(!setsBody.children.length) addSetRow(); }
  if(k==="Endurance"){ $("#ruckWrap").style.display = ($("#modality").value==="Ruck") ? "" : "none"; }
}
$("#modality").addEventListener("change", ()=>{ $("#ruckWrap").style.display = ($("#modality").value==="Ruck") ? "" : "none"; });

/* ================= Init ================= */
document.addEventListener("DOMContentLoaded", ()=>{
  ["sleep","food","sore","mood"].forEach(id=>{ const el=$("#"+id); if(!el.value) el.value = 1; });
  updateReco();
  adaptBuilder();
  renderDashboard();
});
</script>
</body>
</html>
