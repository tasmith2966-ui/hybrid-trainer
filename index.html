<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hybrid Trainer — Clean v11</title>
<meta name="theme-color" content="#0b0b0c" />
<style>
  :root {
    --bg:#0b0b0c;
    --card:#141416;
    --muted:#9aa0a6;
    --text:#e7e9ea;
    --accent:#1db954;
    --warn:#f59e0b;
    --danger:#ef4444;
    --line:#24262a;
    --btn-bg:#1f2937;
    --btn-text:#ffffff;
    --btn-hover:#2a3648;
    --btn-bad-bg:#2a1b1b;
    --btn-bad-text:#ffffff;
    --btn-bad-hover:#3a2222;
    --btn-green-bg:#176b3d;
    --btn-green-text:#ffffff;
    --btn-green-hover:#1b7d47;
    --pill-bg:#1f2937;
    --pill-text:#d1fae5;
    --pill-ok-bg:rgba(16,185,129,.15);
    --pill-ok-text:#34d399;
    --pill-warn-bg:rgba(245,158,11,.15);
    --pill-warn-text:#f59e0b;
    --input-bg:#1f2227;
    --input-border:#2a2d33;
    --input-text:#e7e9ea;
    --table-head-bg:#1a1d22;
    --table-border:#2b2e35;
    --tag-bg:#0b1b30;
    --tag-border:#173152;
    --tag-text:#93c5fd;
    --toast-bg:#1f2937;
    --toast-border:#2a2d33;
    --toast-text:#e7e9ea;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
  body[data-theme="pacman"],body.theme-pacman{
    --bg:#040218;
    --card:#0c1032;
    --muted:#9ba6ff;
    --text:#fffbd1;
    --accent:#ffd800;
    --warn:#ffb347;
    --danger:#ff4d6d;
    --line:#1f2359;
    --btn-bg:#1621a6;
    --btn-text:#ffe066;
    --btn-hover:#1e2ed6;
    --btn-bad-bg:#4a144f;
    --btn-bad-text:#ffe4f1;
    --btn-bad-hover:#5f1b67;
    --btn-green-bg:#1f8f42;
    --btn-green-text:#fffbd1;
    --btn-green-hover:#27a24d;
    --pill-bg:rgba(22,33,166,.25);
    --pill-text:#ffe066;
    --pill-ok-bg:rgba(255,216,0,.3);
    --pill-ok-text:#fffbd1;
    --pill-warn-bg:rgba(255,149,0,.25);
    --pill-warn-text:#ffd199;
    --input-bg:#12183f;
    --input-border:#232b6b;
    --input-text:#fffbd1;
    --table-head-bg:#12183f;
    --table-border:#232b6b;
    --tag-bg:#1621a6;
    --tag-border:#2732c2;
    --tag-text:#ffe066;
    --toast-bg:#12183f;
    --toast-border:#232b6b;
    --toast-text:#fffbd1;
  }
  .wrap{width:min(100%,1120px);margin:24px auto;padding:0 40px}
  h1{font-size:24px;margin:0 0 6px}
  h2{font-size:18px;margin:0 0 8px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:900px){
    .wrap{padding:0 32px}
    .row{grid-template-columns:1fr}
  }
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .muted{color:var(--muted)} .small{font-size:12px}
  .btn{background:var(--btn-bg);color:var(--btn-text);border:none;border-radius:12px;padding:8px 12px;cursor:pointer;transition:background .15s ease,color .15s ease}
  .btn:hover{background:var(--btn-hover)}
  .btn.bad{background:var(--btn-bad-bg);color:var(--btn-bad-text)}.btn.bad:hover{background:var(--btn-bad-hover)}
  .btn.green{background:var(--btn-green-bg);color:var(--btn-green-text)}.btn.green:hover{background:var(--btn-green-hover)}
  .pill{display:inline-block;background:var(--pill-bg);color:var(--pill-text);border-radius:999px;padding:4px 8px;font-size:12px}
  .pill.ok{background:var(--pill-ok-bg);color:var(--pill-ok-text)}
  .pill.warn{background:var(--pill-warn-bg);color:var(--pill-warn-text)}
  .grid{display:grid;gap:8px}
  .g2{grid-template-columns:1fr 1fr}.g3{grid-template-columns:repeat(3,1fr)}.g4{grid-template-columns:repeat(4,1fr)}
  input[type=number],input[type=text],select{width:100%;background:var(--input-bg);border:1px solid var(--input-border);color:var(--input-text);border-radius:10px;padding:8px}
  input[type=range]{width:100%}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .toolbar{gap:10px}
  .space{justify-content:space-between}
  .list{max-height:180px;overflow:auto;border-top:1px solid var(--line);margin-top:8px;padding-top:8px;-webkit-overflow-scrolling:touch}
  .line{height:1px;background:var(--line);margin:10px 0}
  label.small{display:flex;flex-direction:column;gap:4px}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:var(--toast-bg);color:var(--toast-text);border:1px solid var(--toast-border);border-radius:12px;padding:8px 12px;opacity:0;pointer-events:none;transition:opacity .2s;z-index:9999}
  .toast.show{opacity:1}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--table-border);padding:6px 8px;text-align:left}
  th{background:var(--table-head-bg);font-weight:600}
  td input{width:100%}
  .tag{font-size:11px;color:var(--tag-text);background:var(--tag-bg);border:1px solid var(--tag-border);border-radius:999px;padding:2px 6px}
  .qa-item{display:flex;gap:8px;align-items:flex-start}
  .qa-item .pill{flex-shrink:0;margin-top:2px}
  .qa-empty{color:var(--muted)}
  @media (max-width:720px){
    .space.flex{flex-direction:column;align-items:flex-start;gap:16px}
    .space.flex > *{width:100%}
    .grid.g3{grid-template-columns:repeat(2,1fr)}
    .grid.g4{grid-template-columns:repeat(2,1fr)}
  }
  @media (max-width:640px){
    .toolbar{flex-direction:column;align-items:stretch;justify-content:flex-start;width:100%}
    .toolbar > *{width:100%}
    .card{padding:12px}
    h1{font-size:22px}
    h2{font-size:16px}
    table{font-size:12px;min-width:520px;white-space:nowrap}
    th,td{padding:6px}
    .list{max-height:240px;font-size:13px}
  }
  @media (max-width:600px){
    .wrap{padding:0 20px}
    .grid.g3{grid-template-columns:1fr}
    .grid.g4{grid-template-columns:1fr}
  }
  @media (max-width:480px){
    h1{font-size:20px}
    h2{font-size:15px}
    .card{padding:10px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="space flex">
      <div>
        <h1>Hybrid Trainer — Clean v11</h1>
        <div class="muted small">Single HTML. Local save + export/import. No service worker.</div>
      </div>
      <div class="flex toolbar">
        <button id="exportBtn" class="btn">Export</button>
        <label class="btn"><input id="importFile" type="file" accept="application/json" style="display:none">Import</label>
        <button id="resetWeek" class="btn">Reset Week</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="card">
        <h2>Readiness</h2>
        <div class="muted small" style="margin-bottom:8px">0=Bad, 1=Fine, 2=Good. Worst days → <b>GPP Bad</b>.</div>
        <div class="grid">
          <div class="g3 grid">
            <label class="small">Sleep <input type="range" min="0" max="2" step="1" id="sleep" value="1"></label>
            <label class="small">Nutrition <input type="range" min="0" max="2" step="1" id="food" value="1"></label>
            <label class="small">Soreness <input type="range" min="0" max="2" step="1" id="sore" value="1"></label>
          </div>
          <div class="g2 grid">
            <label class="small">Mood <input type="range" min="0" max="2" step="1" id="mood" value="1"></label>
            <label class="small">Morning BW <input type="number" inputmode="numeric" pattern="[0-9]*" id="bw" placeholder="lbs/kg"></label>
          </div>
          <div><label class="small">Sleep (hrs) <input type="number" inputmode="numeric" pattern="[0-9]*" id="sleepHrs" min="0" step="0.5"></label></div>
        </div>
      </div>

      <div class="card">
        <h2>Recommendation</h2>
        <div class="flex" style="flex-wrap:wrap;gap:6px 8px;margin-bottom:8px">
          <span id="recoPill" class="pill">—</span>
          <span id="recoHint" class="pill"></span>
        </div>
        <div class="g2 grid">
          <label class="small">Day type
            <select id="dayKind">
              <option>Strength</option>
              <option>Endurance</option>
              <option>GPP Good</option>
              <option>GPP Bad</option>
              <option>Recovery</option>
            </select>
          </label>
          <label class="small" id="modWrap" style="display:none">Endurance Modality
            <select id="modality">
              <option>Row</option><option>Bike</option><option>Run</option><option>Ruck</option><option>Swim</option><option>Other</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div id="builderCard" class="card" style="margin-top:14px">
      <h2 id="buildTitle">Build Today’s Session</h2>
      <div class="muted small">Per-set <b>Fail</b> = only mark if technique blows up or you truly failed. Otherwise it counts.</div>

      <!-- Strength -->
      <div id="strengthView" style="display:none">
        <div class="line"></div>
        <div class="g4 grid">
          <label class="small">Pattern
            <select id="pattern">
              <option>Hinge</option><option>Squat</option><option>Oly</option><option>None</option>
            </select>
          </label>
          <label class="small">Movement (top 3)
            <select id="movement"></select>
          </label>
          <label class="small">Rest (min)<input type="number" inputmode="numeric" pattern="[0-9]*" id="restMin" min="2" max="5" step="0.5" value="3"></label>
          <label class="small">Target RPE<input type="number" inputmode="numeric" pattern="[0-9]*" id="rpe" min="5" max="10" step="0.5" value="8"></label>
        </div>
        <div class="small muted" id="progGhost" style="margin-top:6px"></div>

        <div class="card" style="margin-top:10px">
          <div class="space flex">
            <div><b>Main Lifts</b> <span class="muted small">Enter each work set</span></div>
            <div class="small">Hard sets: <b id="hardCount">0</b></div>
          </div>
          <div style="overflow:auto">
            <table id="setsTable">
              <thead>
                <tr><th>#</th><th>Movement</th><th>Reps</th><th>Weight</th><th>RPE</th><th>Fail</th><th></th></tr>
              </thead>
              <tbody id="setsBody"></tbody>
            </table>
          </div>
          <div style="margin-top:8px" class="flex">
            <button class="btn" id="addSet">+ Add Set</button>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <div class="space flex">
            <div><b>Optional Finisher WOD</b></div>
            <button class="btn" id="toggleWod">+ Add WOD</button>
          </div>
          <div id="wodWrap" style="display:none;margin-top:8px"></div>
        </div>
      </div>

      <!-- Endurance -->
      <div id="enduranceView" style="display:none">
        <div class="line"></div>
        <div class="g3 grid">
          <label class="small">Duration (min)<input id="z2" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="5" value="30"></label>
          <label class="small">Distance<input id="dist" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="0.1" placeholder="5"></label>
          <label class="small">Unit<select id="distUnit"><option>mi</option><option>km</option></select></label>
        </div>
        <div class="g3 grid" style="margin-top:6px">
          <label class="small" id="ruckWrap" style="display:none">Ruck weight<input id="ruckWeight" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="1" placeholder="lbs"></label>
          <div></div><div></div>
        </div>
        <div class="card" style="margin-top:10px">
          <div class="space flex">
            <div><b>Optional WOD</b></div>
            <button class="btn" id="toggleWod2">+ Add WOD</button>
          </div>
          <div id="wodWrap2" style="display:none;margin-top:8px"></div>
        </div>
        <div style="margin-top:8px"><label class="small">Notes<input id="notes" type="text" placeholder="HR, pace, terrain…"></label></div>
      </div>

      <!-- GPP Good -->
      <div id="gppGoodView" style="display:none">
        <div class="line"></div>
        <div class="card">
          <div><b>Build a WOD</b></div>
          <div id="wodWrap3" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- GPP Bad -->
      <div id="gppBadView" style="display:none">
        <div class="line"></div>
        <div class="card">
          <div><b>Minimum viable session</b> <span class="muted small">12′ AMRAP: Air Squat / Push-Up / Dead Hang</span></div>
          <div id="wodWrap4" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- Recovery -->
      <div id="recoveryView" style="display:none">
        <div class="line"></div>
        <div class="g3 grid">
          <label class="small">Walk (min)<input id="walkMin" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="5" value="30"></label>
          <label class="small">Mobility (min)<input id="mobMin" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="5" value="10"></label>
          <label class="small">Yoga/Breath (min)<input id="yogaMin" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="5" value="10"></label>
        </div>
        <div style="margin-top:8px"><label class="small">Notes<input id="notesRec" type="text" placeholder="How you felt…"></label></div>
      </div>

      <div class="line"></div>

      <!-- Accessories -->
      <div id="accWrap">
        <div class="space flex">
          <h3 style="margin:0">Accessories</h3>
          <div class="flex toolbar" style="flex-wrap:wrap;gap:6px 8px">
            <select id="newAccTarget">
              <option>Back</option><option>Chest</option><option>Delts</option><option>Arms</option>
              <option>Quads</option><option>Posterior</option><option>Calves</option><option>Tib</option>
              <option>Core</option>
            </select>
            <input id="newAccName" type="text" placeholder="Accessory name">
            <input id="newAccLoad" type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="1" placeholder="Weight or plate">
            <button class="btn" id="addManualAcc">+ Add</button>
          </div>
        </div>
        <div class="muted small" id="accHelp" style="margin-top:6px">
          Defaults: big groups <b>3×8–12</b>, arms <b>3×10–15</b>, calves/tib/core <b>3×12–20</b>. 1–3 RIR.
        </div>
        <div id="accList" class="grid" style="margin-top:8px"></div>
      </div>

      <div class="card" id="qaCard" style="margin-top:10px">
        <div class="space flex">
          <div>
            <b>QA Check</b>
            <div class="muted small">Spot issues before you save + run it.</div>
          </div>
          <button class="btn" id="qaBtn">Run QA</button>
        </div>
        <div id="qaList" class="grid" style="margin-top:8px;gap:6px">
          <div class="qa-empty muted small">Run QA to check the plan.</div>
        </div>
      </div>

      <div class="space flex" style="margin-top:12px">
        <button class="btn green" id="saveBtn">Save Session</button>
        <div class="muted small">Compounds rest ≥2–3′ · Accessories 60–90s · WOD time counts as vigorous</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2>Weekly Dashboard</h2>
      <div class="row">
        <div class="card">
          <div class="space flex"><div>Lower Body Sets</div></div>
          <div class="grid">
            <div>Quads: <b id="qSets">0</b> <span id="qStatus" class="pill"></span></div>
            <div>Posterior: <b id="pSets">0</b> <span id="pStatus" class="pill"></span></div>
            <div class="muted small">Targets — Quads ≥10 · Posterior ≥10</div>
          </div>
        </div>
        <div class="card">
          <div>Upper/Other Sets</div>
          <div class="g2 grid" style="margin-top:6px">
            <div>Chest <b id="cSets">0</b></div><div>Back <b id="bSets">0</b></div>
            <div>Delts <b id="dSets">0</b></div><div>Arms <b id="aSets">0</b></div>
          </div>
          <div style="margin-top:6px">Core <b id="coreSets">0</b> <span id="coreStatus" class="pill"></span></div>
          <div class="muted small" style="margin-top:6px">Targets — Chest 10 · Back 12 · Delts 10 · Arms 8 · Core 8</div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <div class="card">
          <div>Endurance Minutes</div>
          <div class="g2 grid" style="margin-top:6px">
            <div>Z2 <b id="z2Min">0′</b></div><div>Vig <b id="vigMin">0′</b></div>
          </div>
          <div id="endStatus" class="pill" style="margin-top:6px"></div>
        </div>
        <div class="card">
          <div>History (This Week)</div>
          <div id="hist" class="list"></div>
        </div>
      </div>
      <div class="muted small" style="margin-top:8px;text-align:center">
        Clean build v11 — no PWA cache.
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ================= Versions & Storage ================= */
const APP_VERSION = 11;
const STORE_KEY = "hybrid_v11";

/* ================= Utilities ================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = () => Math.random().toString(36).slice(2,9);
const todayISO = () => { const d=new Date(); d.setHours(0,0,0,0); return d.toISOString(); };
const weekKey = (()=>{ const d=new Date(), onejan=new Date(d.getFullYear(),0,1); const w=Math.ceil((((d-onejan)/86400000)+onejan.getDay()+1)/7); return `${d.getFullYear()}-W${String(w).padStart(2,"0")}`; })();
function load(k,f){ try{ const s=localStorage.getItem(k); return s?JSON.parse(s):f }catch{ return f } }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 2000); }
function badge(el, ok, onTxt="On track", offTxt="Low"){ el.className = "pill " + (ok ? "ok" : "warn"); el.textContent = ok ? onTxt : offTxt; }

/* ================= Data ================= */
let store = load(STORE_KEY, { version: APP_VERSION, weeks: {} });
function week(){ if(!store.weeks[weekKey]) store.weeks[weekKey] = { sessions: [], recovery: [] }; return store.weeks[weekKey]; }
function saveStore(){ save(STORE_KEY, store); }

/* ================= Targets ================= */
const TARGETS = { Quads:10, Posterior:10, Chest:10, Back:12, Delts:10, Arms:8, Core:8 };

/* ================= UI Refs ================= */
const sleep = $("#sleep"), food=$("#food"), sore=$("#sore"), mood=$("#mood");
const bw=$("#bw"), sleepHrs=$("#sleepHrs");
const recoPill = $("#recoPill"), recoHint=$("#recoHint");
const dayKind = $("#dayKind"), modWrap=$("#modWrap"), modality=$("#modality");

const strengthView = $("#strengthView"),
      enduranceView = $("#enduranceView"),
      gppGoodView  = $("#gppGoodView"),
      gppBadView   = $("#gppBadView"),
      recoveryView = $("#recoveryView");

const pattern  = $("#pattern"),
      movement = $("#movement"),
      restMin  = $("#restMin"),
      rpe      = $("#rpe");

const setsBody = $("#setsBody"),
      addSetBtn = $("#addSet"),
      hardCount = $("#hardCount"),
      progGhost = $("#progGhost");

const toggleWod  = $("#toggleWod"),
      wodWrap    = $("#wodWrap"),
      toggleWod2 = $("#toggleWod2"),
      wodWrap2   = $("#wodWrap2"),
      wodWrap3   = $("#wodWrap3"),
      wodWrap4   = $("#wodWrap4");

const accList       = $("#accList"),
      newAccTarget  = $("#newAccTarget"),
      newAccName    = $("#newAccName"),
      newAccLoad    = $("#newAccLoad"),
      qaBtn         = $("#qaBtn"),
      qaList        = $("#qaList"),
      builderCard   = $("#builderCard");

function markQAStale(msg="Session changed — run QA again."){
  if(!qaList) return;
  qaList.innerHTML = `<div class="qa-empty muted small">${msg}</div>`;
}

function handleBuilderAdjust(e){
  if(e.target.closest("#qaCard")) return;
  markQAStale();
}

if(builderCard){
  ["input","change"].forEach(evt=> builderCard.addEventListener(evt, handleBuilderAdjust));
}

/* ================= Recommendation ================= */
function recommend(s,f,so,m){ const n=(s+f+so+m)/8; if(n>=0.82) return "Strength"; if(n>=0.65) return "GPP Good"; if(n>=0.48) return "Endurance"; return "GPP Bad"; }
const numVal = el => { const n = Number(el?.value); return Number.isFinite(n)?n:1; };

function updateReco(){
  const r = recommend(numVal(sleep),numVal(food),numVal(sore),numVal(mood));
  if(!dayKind.__manualPick) dayKind.value = r;
  recoPill.textContent = r;
  recoHint.textContent = r==="Strength"?"Long rests · 3–6 reps · RPE 7–9":(r==="Endurance"?"30–40′ Z2 preferred":"");
  adaptBuilder();
}
["input","change"].forEach(evt=>{ [sleep,food,sore,mood].forEach(el=> el.addEventListener(evt, updateReco)); });
dayKind.addEventListener("change", ()=>{ dayKind.__manualPick = true; adaptBuilder(); });
["input","change"].forEach(evt=>{ [sleep,food,sore,mood].forEach(el=> el.addEventListener(evt, ()=> dayKind.__manualPick=false)); });

/* ================= Strength Main Lifts ================= */
const TOP3 = {
  Hinge:["Conventional Deadlift","Trap Bar Deadlift","Romanian Deadlift"],
  Squat:["Back Squat","Front Squat","Pause Back Squat"],
  Oly:["Clean & Jerk","Clean","Snatch"],
  None:["—"]
};
function renderTop3(){
  const list = TOP3[pattern.value] || ["—"];
  movement.innerHTML = list.map(x=>`<option>${x}</option>`).join("");
  progGhost.textContent="";
}
pattern.addEventListener("change", renderTop3);

function addSetRow(vals={ reps:"", load:"", rpe:"", fail:false }){
  const tr = document.createElement("tr");
  const idx = setsBody.children.length + 1;
  tr.innerHTML = `
    <td><span class="tag">Set ${idx}</span></td>
    <td>${movement.value || pattern.value}</td>
    <td><input type="number" min="1" step="1" value="${vals.reps}"></td>
    <td><input type="number" min="0" step="1" value="${vals.load}"></td>
    <td><input type="number" min="5" max="10" step="0.5" value="${vals.rpe}"></td>
    <td style="text-align:center"><input type="checkbox" ${vals.fail?"checked":""}></td>
    <td><button class="btn bad">X</button></td>`;
  const [_,__,reps,load,rpe,fail,del] = tr.children;
  const delBtn = del.querySelector("button");
  delBtn.addEventListener("click", ()=>{ tr.remove(); recountHardSets(); refreshSetNumbers(); markQAStale(); });
  [reps.querySelector("input"),load.querySelector("input"),rpe.querySelector("input"),fail.querySelector("input")].forEach(inp=> inp.addEventListener("input", ()=>{ recountHardSets(); updateProgHint(); }));
  setsBody.appendChild(tr);
  recountHardSets(); updateProgHint(); markQAStale();
}
function refreshSetNumbers(){
  [...setsBody.children].forEach((tr,i)=>{ tr.firstElementChild.innerHTML = `<span class="tag">Set ${i+1}</span>`; });
}
function recountHardSets(){
  let count=0;
  [...setsBody.querySelectorAll("tr")].forEach(tr=>{
    const reps=Number(tr.children[2].querySelector("input").value||0);
    const load=Number(tr.children[3].querySelector("input").value||0);
    const fail=tr.children[5].querySelector("input").checked;
    if(reps>0 && load>0 && !fail) count++;
  });
  hardCount.textContent = count;
}
function updateProgHint(){
  const good=[];
  [...setsBody.querySelectorAll("tr")].forEach(tr=>{
    const reps=Number(tr.children[2].querySelector("input").value||0);
    const load=Number(tr.children[3].querySelector("input").value||0);
    const rpe=Number(tr.children[4].querySelector("input").value||0);
    const fail=tr.children[5].querySelector("input").checked;
    if(!fail && rpe>0 && rpe<=9.5 && reps>0 && load>0){ good.push({reps,load}); }
  });
  if(!good.length){ progGhost.textContent=""; return; }
  const best = Math.max(...good.map(s=> s.load*(1+s.reps/30)));
  const upper = ["Bench","Press","Row","Pulldown","Pull-Up","DB"].some(k=> (movement.value||"").includes(k));
  progGhost.textContent = upper ? "Next: push reps toward 10–12 before adding load" : "Next: +2.5–5 lb if ≤8 RPE at target reps";
}
addSetBtn.addEventListener("click", ()=> addSetRow());

/* ================= WOD Builder (simple) ================= */
function buildWodUI(container, preset){
  container.innerHTML = `
    <div class="g4 grid">
      <label class="small">Style
        <select class="w-style"><option>AMRAP</option><option>For Time</option><option>EMOM</option><option>Intervals</option><option>Chipper</option></select>
      </label>
      <label class="small">Name (optional)<input class="w-name" type="text" placeholder="e.g., 4RFT Row/Wall Ball/Sit-Up"></label>
      <label class="small">Time (min)<input class="w-cap" type="number" min="0" step="1" value="20"></label>
      <label class="small">Rounds<input class="w-rounds" type="number" min="1" step="1" value="${preset==='bad'?1:3}"></label>
    </div>
    <div class="line"></div>
    <div class="space flex"><div><b>Movements</b></div><button class="btn w-add">+ Add Movement</button></div>
    <div class="w-list grid" style="margin-top:6px"></div>
    <div class="muted small" style="margin-top:6px">Mark BW if body-weight.</div>`;
  const add = container.querySelector(".w-add");
  const list = container.querySelector(".w-list");
  function addMove(nameV="", repsV="", loadV="", bw=false, quiet=false){
    const row = document.createElement("div");
    row.className="grid g4";
    row.innerHTML=`
      <input placeholder="Movement (e.g., KB Swing)" value="${nameV}">
      <input placeholder="Reps/Time (e.g., 15 or 30s)" value="${repsV}">
      <input placeholder="Load (e.g., 24kg or light)" value="${loadV}">
      <div class="flex toolbar" style="justify-content:space-between">
        <label class="small" style="flex-direction:row;gap:8px;align-items:center"><input class="w-bw" type="checkbox" ${bw?"checked":""}> BW</label>
        <button class="btn bad w-del">X</button>
      </div>`;
    row.querySelector(".w-del").addEventListener("click", ()=>{ row.remove(); markQAStale(); });
    list.appendChild(row);
    if(!quiet) markQAStale();
  }
  if(preset==="bad"){
    [["Air Squat","15","BW",true],["Push-Up","10","BW",true],["Dead Hang (sec)","20","BW",true]].forEach(x=>addMove(...x, true));
  }
  add.addEventListener("click", ()=> addMove());
  container.addEventListener("input", e=>{ if(!e.target.closest(".w-del")) markQAStale(); });
  container.addEventListener("change", e=>{ if(!e.target.closest(".w-del")) markQAStale(); });
  return { read(){
    const style = container.querySelector(".w-style").value;
    const name  = container.querySelector(".w-name").value.trim();
    const cap   = Number(container.querySelector(".w-cap").value||0);
    const rounds= Number(container.querySelector(".w-rounds").value||1);
    const moves=[...container.querySelectorAll(".w-list > div")].map(row=>{
      const [n,r,l] = row.querySelectorAll("input");
      const bw = row.querySelector(".w-bw")?.checked || false;
      return {name:n.value.trim(), reps:r.value.trim(), load:l.value.trim(), bw};
    }).filter(m=>m.name);
    return {style,name,cap,rounds,moves};
  }};
}
let wodUI=null, wodUI2=null, wodUI3=null, wodUI4=null;

$("#toggleWod").addEventListener("click", ()=>{
  if(wodWrap.style.display==="none"){ wodWrap.style.display=""; wodUI = buildWodUI(wodWrap); $("#toggleWod").textContent="Remove WOD"; }
  else { wodWrap.style.display="none"; wodWrap.innerHTML=""; $("#toggleWod").textContent="+ Add WOD"; wodUI=null; }
  markQAStale();
});
$("#toggleWod2").addEventListener("click", ()=>{
  if(wodWrap2.style.display==="none"){ wodWrap2.style.display=""; wodUI2 = buildWodUI(wodWrap2); $("#toggleWod2").textContent="Remove WOD"; }
  else { wodWrap2.style.display="none"; wodWrap2.innerHTML=""; $("#toggleWod2").textContent="+ Add WOD"; wodUI2=null; }
  markQAStale();
});

/* ================= Accessories ================= */
let accessories=[];
function addAccessory(target,name,sets,reps,load=""){
  const id = uid();
  const row = document.createElement("div");
  row.className = "grid g4"; row.style.gridTemplateColumns="2fr 1fr 1fr 1fr auto";
  row.dataset.id = id;
  row.innerHTML = `<div><b>${name}</b><div class="muted small">${target}</div></div>
    <label class="small">Sets<input type="number" min="2" max="5" value="${sets}"></label>
    <label class="small">Reps<input type="number" min="6" max="25" value="${reps}"></label>
    <label class="small">Weight<input type="number" min="0" step="1" placeholder="Weight" value="${load}"></label>
    <button class="btn bad">X</button>`;
  $("#accList").appendChild(row);
  const delBtn = row.querySelector("button");
  const [setsEl,repsEl,loadEl] = row.querySelectorAll("input");
  delBtn.addEventListener("click", ()=>{ row.remove(); accessories = accessories.filter(a=>a.id!==id); markQAStale(); });
  accessories.push({id,target,name,setsEl,repsEl,loadEl});
  markQAStale();
}
$("#addManualAcc").addEventListener("click", ()=>{
  const t = newAccTarget.value || "Back";
  const name = newAccName.value.trim() || "Accessory";
  const load = newAccLoad.value || "";
  const defaults = (t==="Calves"||t==="Core")?{sets:3,reps:15} : (t==="Arms"?{sets:3,reps:12}:{sets:3,reps:10});
  addAccessory(t, name, defaults.sets, defaults.reps, load);
  newAccName.value=""; newAccLoad.value="";
});

/* ================= QA Checks ================= */
function renderQAList(issues){
  if(!qaList) return;
  qaList.innerHTML = "";
  if(!issues.length){
    const row = document.createElement("div");
    row.className = "qa-item";
    row.innerHTML = `<span class="pill ok">Ready</span><div>Session looks good — go run it.</div>`;
    qaList.appendChild(row);
    return;
  }
  issues.forEach(issue=>{
    const row = document.createElement("div");
    row.className = "qa-item";
    const pill = document.createElement("span");
    pill.className = issue.level==="warn" ? "pill warn" : (issue.level==="info" ? "pill" : "pill ok");
    pill.textContent = issue.level==="warn" ? "Warn" : (issue.level==="info" ? "Info" : "OK");
    const text = document.createElement("div");
    text.textContent = issue.message;
    row.append(pill, text);
    qaList.appendChild(row);
  });
}

function qaCollect(){
  const session = draftSession();
  const issues = [];
  const warn = msg => issues.push({level:"warn", message:msg});
  const info = msg => issues.push({level:"info", message:msg});
  const readiness = recommend(numVal(sleep),numVal(food),numVal(sore),numVal(mood));

  if(session.kind==="Strength" && (readiness==="GPP Bad" || readiness==="Recovery")){
    warn("Readiness is low — consider swapping to a lighter day or scaling the strength work.");
  } else if(session.kind!==readiness){
    info(`Readiness suggestion: ${readiness}. Make sure this plan matches how you feel.`);
  }

  if(session.kind==="Strength"){
    const detail = session.main?.setsDetail || [];
    const quality = detail.filter(s=>!s.fail && s.reps>0 && s.load>0);
    if(!quality.length) warn("Add at least one quality main set with reps and load.");
    if(quality.length>0 && quality.length<3) warn("Log ≥3 quality main sets on strength days to drive progress.");
    if(quality.some(s=>!s.rpe || s.rpe<6)) info("Fill in RPE 6–9 for every quality set to guide programming.");
    if((session.main?.rest||0) < 2) info("Rest ≥2 minutes between main sets so they count as hard work.");
    const fails = detail.filter(s=>s.fail).length;
    if(fails) info(`You marked ${fails} set${fails>1?"s":""} as fail — adjust loading next time.`);
  }

  if(session.kind==="Endurance"){
    const z2 = Number($("#z2").value||0);
    const cap = session.wod?.cap || 0;
    if(z2 < 20 && cap < 15) warn("Aim for ≥20′ of Zone 2 or structured intervals on endurance days.");
    if(session.wod && (!session.wod.moves || !session.wod.moves.length)) warn("Add movements to the optional endurance WOD.");
    if($("#modality").value==="Ruck" && !Number($("#ruckWeight").value||0)) info("Log the ruck weight to track the load." );
  }

  if(session.kind==="GPP Good" || session.kind==="GPP Bad"){
    const moves = session.wod?.moves?.length || 0;
    if(!moves) warn("Add at least one movement to the GPP WOD.");
    if((session.wod?.cap||0) < 10) info("Consider a 10′+ cap so the GPP piece has enough density.");
  }

  if(session.kind==="Recovery"){
    const walk = Number($("#walkMin").value||0);
    const mob = Number($("#mobMin").value||0);
    const yoga = Number($("#yogaMin").value||0);
    if((walk+mob+yoga) < 30) warn("Stack at least 30′ of walking, mobility, or breath work on recovery days.");
  }

  const accMissing = session.acc.filter(a=> (Number(a.sets)||0)===0 || (Number(a.reps)||0)===0);
  if(accMissing.length) warn("Fill in sets and reps for every accessory.");
  const accTotal = session.acc.reduce((sum,a)=> sum + (Number(a.sets)||0),0);
  if(accTotal > 18) info("Accessory volume is high — ensure you can recover from it.");

  return {session, issues};
}

function runQA(opts={}){
  const {silent=false} = opts;
  const result = qaCollect();
  renderQAList(result.issues);
  const hasWarn = result.issues.some(i=>i.level==="warn");
  if(!silent){
    toast(hasWarn ? "QA flagged items — review the list below." : "QA passed. Ready to run it.");
  }
  return {...result, hasWarn};
}

if(qaBtn){
  qaBtn.addEventListener("click", ()=> runQA());
}

/* ================= Session Save & Totals ================= */
function draftSession(){
  const kind = dayKind.value;
  const main = (kind==="Strength") ? {
    pattern: pattern.value,
    movement: movement.value || pattern.value,
    rpe: Number(rpe.value)||8,
    rest: Number(restMin.value)||3,
    sets: [...setsBody.querySelectorAll("tr")].filter(tr=>{
      const reps=Number(tr.children[2].querySelector("input").value||0);
      const load=Number(tr.children[3].querySelector("input").value||0);
      const fail=tr.children[5].querySelector("input").checked;
      return reps>0 && load>0 && !fail;
    }).length,
    setsDetail: [...setsBody.querySelectorAll("tr")].map(tr=>({
      reps:Number(tr.children[2].querySelector("input").value||0),
      load:Number(tr.children[3].querySelector("input").value||0),
      rpe:Number(tr.children[4].querySelector("input").value||0)||null,
      fail:tr.children[5].querySelector("input").checked
    }))
  } : null;

  let endurance = null;
  let recoveryPlan = null;
  let wod = null;

  if(kind==="Strength"){
    if(wodUI) wod = wodUI.read();
  } else if(kind==="Endurance"){
    const z2 = Number($("#z2").value||0);
    const distanceVal = Number($("#dist").value);
    const distance = (Number.isFinite(distanceVal) && distanceVal>0) ? distanceVal : null;
    const ruckVal = Number($("#ruckWeight").value);
    const modalityVal = $("#modality")?.value || "";
    endurance = {
      z2,
      vig: 0,
      distance,
      distUnit: $("#distUnit")?.value || "mi",
      modality: modalityVal,
      ruckWeight: (modalityVal==="Ruck" && Number.isFinite(ruckVal) && ruckVal>0) ? ruckVal : null,
      notes: $("#notes")?.value.trim() || ""
    };
    if(wodUI2) wod = wodUI2.read();
  } else if(kind==="GPP Good"){
    if(!wodUI3) wodUI3 = buildWodUI(wodWrap3, "good");
    wod = wodUI3.read();
  } else if(kind==="GPP Bad"){
    if(!wodUI4) wodUI4 = buildWodUI(wodWrap4, "bad");
    wod = wodUI4.read();
  } else if(kind==="Recovery"){
    const walk = Number($("#walkMin").value||0);
    const mob = Number($("#mobMin").value||0);
    const yoga = Number($("#yogaMin").value||0);
    recoveryPlan = {
      walk,
      mobility: mob,
      yoga,
      notes: $("#notesRec")?.value.trim() || ""
    };
  }

  const acc = accessories.map(a=>({target:a.target, name:a.name, sets:Number(a.setsEl.value||0), reps:Number(a.repsEl.value||0), load:a.loadEl.value}));
  return { id: uid(), date: todayISO(), kind, main, endurance, recovery: recoveryPlan, wod, acc, version: APP_VERSION };
}
const WOD_CREDIT_RULES = [
  {match:/\bthruster\b|wall ball/i, add:{quads:1, delts:1}},
  {match:/\bburpee\b/i, add:{quads:1, chest:1}},
  {match:/\bclean\b/i, add:{quads:1, post:1}},
  {match:/\bsnatch\b/i, add:{post:1, delts:1}},
  {match:/\bswing\b|\bdeadlift\b|hinge|hip thrust|good morning|\brdl\b|glute bridge/i, add:{post:1}},
  {match:/squat|lunge|step-?up|box jump|pistol/i, add:{quads:1}},
  {match:/push-up|pushup|bench|dip/i, add:{chest:1}},
  {match:/\brow\b|pull-?up|chin-?up|rope climb|ring row|muscle-up/i, add:{back:1}},
  {match:/strict press|push press|press\b|jerk|handstand|hspu|wall walk|overhead/i, add:{delts:1}},
  {match:/curl|tricep|triceps|bicep|hammer/i, add:{arms:1}},
  {match:/sit-?up|situp|toe-?s?-?to-?bar|leg raise|knee raise|v-?up|plank|hollow|ghd|dead bug|mountain climber/i, add:{core:1}},
  {match:/carry|sandbag|yoke/i, add:{core:1, post:1}}
];
function creditWodMovement(name, rounds, totals){
  if(!name) return;
  const lower = name.toLowerCase();
  WOD_CREDIT_RULES.forEach(rule=>{
    if(rule.match.test(lower)){
      Object.entries(rule.add).forEach(([k,v])=>{ if(k in totals) totals[k] += v*rounds; });
    }
  });
}
function totalsCalc(sess){
  const t = {quads:0,post:0,chest:0,back:0,delts:0,arms:0,core:0, z2:0,vig:0, strength:0};
  (sess||[]).forEach(s=>{
    if(s.main && s.main.pattern && s.main.sets){
      const add = s.main.sets;
      if(s.main.pattern==="Squat") t.quads += add;
      if(s.main.pattern==="Hinge") t.post += add;
      if(s.main.pattern==="Oly"){ t.quads += Math.ceil(add/2); t.post += Math.floor(add/2); }
    }
    if(s.endurance){ t.z2 += s.endurance.z2||0; t.vig += s.endurance.vig||0; }
    if(s.wod){
      const rounds = Math.max(1, Number(s.wod.rounds)||1);
      if(s.wod.cap) t.vig += Number(s.wod.cap)||0;
      (s.wod.moves||[]).forEach(m=> creditWodMovement(m?.name||"", rounds, t));
    }
    (s.acc||[]).forEach(a=>{
      if(a.target==="Quads") t.quads += a.sets;
      if(a.target==="Posterior") t.post += a.sets;
      if(a.target==="Chest") t.chest += a.sets;
      if(a.target==="Back") t.back += a.sets;
      if(a.target==="Delts") t.delts += a.sets;
      if(a.target==="Arms") t.arms += a.sets;
      if(a.target==="Core") t.core += a.sets;
    });
    if(s.kind==="Strength") t.strength++;
  });
  return t;
}
function runTotalsTests(){
  const baseSession = [{
    kind:"Strength",
    main:{pattern:"Squat", sets:3},
    wod:{cap:12, rounds:2, moves:[{name:"Wall Ball"},{name:"Pull-Up"}]},
    acc:[]
  }];
  const t1 = totalsCalc(baseSession);
  console.assert(t1.quads===5, "WOD quads credit mismatch", t1);
  console.assert(t1.back===2, "WOD back credit mismatch", t1);
  console.assert(t1.delts===2, "WOD delts credit mismatch", t1);
  console.assert(t1.vig===12, "WOD minutes should credit vigorous time", t1);

  const gppSession = [{
    kind:"GPP Good",
    wod:{cap:15, rounds:3, moves:[{name:"Sit-Up"},{name:"Sandbag Carry"}]},
    acc:[]
  }];
  const t2 = totalsCalc(gppSession);
  console.assert(t2.core===6 && t2.post===3, "GPP WOD accessory credits mismatch", t2);
  console.assert(t2.vig===15, "GPP WOD should add vigorous minutes", t2);

  const enduSession = [{
    kind:"Endurance",
    endurance:{z2:40, vig:0},
    wod:{cap:20, rounds:1, moves:[]},
    acc:[]
  }];
  const t3 = totalsCalc(enduSession);
  console.assert(t3.z2===40, "Endurance Z2 minutes mismatch", t3);
  console.assert(t3.vig===20, "Endurance WOD minutes should not double count", t3);
}
function renderDashboard(){
  const t = totalsCalc(week().sessions);
  $("#z2Min").textContent = t.z2+"′"; $("#vigMin").textContent = t.vig+"′";
  $("#qSets").textContent = t.quads; $("#pSets").textContent = t.post;
  $("#cSets").textContent = t.chest||0; $("#bSets").textContent = t.back||0;
  $("#dSets").textContent = t.delts||0; $("#aSets").textContent = t.arms||0; $("#coreSets").textContent = t.core||0;
  badge($("#qStatus"), t.quads>=TARGETS.Quads); badge($("#pStatus"), t.post>=TARGETS.Posterior);
  badge($("#coreStatus"), t.core>=TARGETS.Core);
  const endOK = (t.z2>=150) || (t.vig>=75) || ((t.z2*0.5 + t.vig)>=75);
  badge($("#endStatus"), endOK, "On track", "Low this week");
  $("#hist").innerHTML = week().sessions.map(s=>{
    const d=new Date(s.date).toLocaleDateString();
    const tag = s.kind==="Strength" ? (s.main?.movement || s.main?.pattern) : (s.wod?.name || s.endurance?.modality || "");
    return `<div class="space flex"><span>${d} · ${s.kind}</span><span class="muted small">${tag||""}</span></div>`;
  }).join("") || '<div class="muted">No sessions yet.</div>';
}

function saveSession(){
  const {session: s, hasWarn} = runQA({silent:true});
  week().sessions.push(s);
  week().recovery.push({ date: todayISO(), bw: (bw.value?Number(bw.value):null), sleepHrs: (sleepHrs.value?Number(sleepHrs.value):null) });
  saveStore();
  // reset builder
  setsBody.innerHTML=""; accessories=[]; $("#accList").innerHTML="";
  if(dayKind.value==="Strength") addSetRow();
  renderDashboard();
  markQAStale();
  toast(hasWarn ? "Saved with QA warnings — check the QA list." : "Session saved.");
}

/* ================= Export / Import / Reset ================= */
$("#exportBtn").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(store,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`hybrid_store_${weekKey}.json`; a.click();
});
$("#importFile").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{ try{ const data = JSON.parse(r.result); if(data && data.weeks){ store = data; saveStore(); renderDashboard(); toast("Import success."); } else toast("Invalid file."); }catch{ toast("Failed to parse JSON."); } };
  r.readAsText(f);
});
$("#resetWeek").addEventListener("click", ()=>{ if(confirm("Reset this week's data?")){ store.weeks[weekKey]={sessions:[],recovery:[],version:APP_VERSION}; saveStore(); renderDashboard(); } });
$("#saveBtn").addEventListener("click", saveSession);

/* ================= Builder + Views ================= */
function adaptBuilder(){
  const k = dayKind.value;
  $("#modWrap").style.display = (k==="Endurance") ? "" : "none";
  $("#buildTitle").textContent = {
    Strength:"Build Today’s Strength Session",
    Endurance:"Build Today’s Endurance Session",
    "GPP Good":"Build Today’s GPP (Good) Session",
    "GPP Bad":"Build Today’s GPP (Bad) Session",
    Recovery:"Plan Today’s Recovery"
  }[k] || "Build Today’s Session";
  strengthView.style.display = (k==="Strength")?"":"none";
  enduranceView.style.display = (k==="Endurance")?"":"none";
  gppGoodView.style.display = (k==="GPP Good")?"":"none";
  gppBadView.style.display = (k==="GPP Bad")?"":"none";
  recoveryView.style.display = (k==="Recovery")?"":"none";
  if(k==="GPP Good" && !wodUI3){ wodUI3 = buildWodUI(wodWrap3, "good"); }
  if(k==="GPP Bad" && !wodUI4){ wodUI4 = buildWodUI(wodWrap4, "bad"); }
  if(k==="Strength"){ if(!movement.options.length) renderTop3(); if(!setsBody.children.length) addSetRow(); }
  if(k==="Endurance"){ $("#ruckWrap").style.display = ($("#modality").value==="Ruck") ? "" : "none"; }
}
$("#modality").addEventListener("change", ()=>{ $("#ruckWrap").style.display = ($("#modality").value==="Ruck") ? "" : "none"; });

/* ================= Init ================= */
document.addEventListener("DOMContentLoaded", ()=>{
  ["sleep","food","sore","mood"].forEach(id=>{ const el=$("#"+id); if(!el.value) el.value = 1; });
  updateReco();
  adaptBuilder();
  renderDashboard();
  runTotalsTests();
});
</script>
</body>
</html>
